"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[28],{2028:(Rs,bt,K)=>{K.d(bt,{MQ:()=>oe,Vy:()=>te,Xp:()=>Le});var $e=K(2250),We=K(8533),_s=K.n(We),Ie=K(4163),Ds=K(7878),Rt=K(9520),ws=K.n(Rt),_t=Object.defineProperty,Dt=Object.defineProperties,wt=Object.getOwnPropertyDescriptors,ce=Object.getOwnPropertySymbols,He=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable,je=(e,t,i)=>t in e?_t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,f=(e,t)=>{for(var i in t||(t={}))He.call(t,i)&&je(e,i,t[i]);if(ce)for(var i of ce(t))Ke.call(t,i)&&je(e,i,t[i]);return e},O=(e,t)=>Dt(e,wt(t)),Je=(e,t)=>{var i={};for(var s in e)He.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(e!=null&&ce)for(var s of ce(e))t.indexOf(s)<0&&Ke.call(e,s)&&(i[s]=e[s]);return i},Nt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),l=(e,t,i)=>new Promise((s,r)=>{var n=c=>{try{d(i.next(c))}catch(h){r(h)}},a=c=>{try{d(i.throw(c))}catch(h){r(h)}},d=c=>c.done?s(c.value):Promise.resolve(c.value).then(n,a);d((i=i.apply(e,t)).next())}),Ot=Nt((e,t)=>{t.exports={name:"@100mslive/hms-video",version:"0.5.4",license:"MIT",main:"dist/index.cjs.js",typings:"dist/index.d.ts",module:"dist/index.js",files:["dist","src"],engines:{node:">=10"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",test:"jest --maxWorkers=1",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",format:"prettier --write src/**/*.ts"},author:"100ms <tech-common@100ms.live>",devDependencies:{"@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1",tslib:"^2.2.0"},dependencies:{eventemitter2:"^6.4.7","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0"},gitHead:"fe00f2f7a62e19cb86e9d7bd8a80bc921909a2bb"}}),ue=class{constructor(e){this.key=e,this.storage=null}getStorage(){return ve&&!this.storage&&(Bt(),this.storage=window.localStorage),this.storage}get(){var e;let t=(e=this.getStorage())==null?void 0:e.getItem(this.key);return t?JSON.parse(t):void 0}set(e){var t;let i=JSON.stringify(e);(t=this.getStorage())==null||t.setItem(this.key,i)}clear(){var e;(e=this.getStorage())==null||e.removeItem(this.key)}},re=new We.UAParser,qe,he=typeof window>"u"&&!((qe=re.getBrowser().name)!=null&&qe.toLowerCase().includes("electron")),ve=typeof window<"u",F;(function(e){e.PROD="prod",e.QA="qa",e.DEV="dev"})(F||(F={}));var Lt=()=>!he,Ns=Lt(),Mt=()=>re.getDevice().type==="mobile",Ut=()=>{let e,t=new ue("hms-analytics-deviceId"),i=t.get();return i?e=i:(e=(0,Ie.Z)(),t.set(e)),e},Ft=()=>typeof document<"u"&&document.hidden,Gt=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(arguments.length===0)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},Bt=()=>{ve&&!localStorage&&(window.localStorage=new Gt)},Ye;(function(e){e[e.VERBOSE=0]="VERBOSE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.TIME=4]="TIME",e[e.TIMEEND=5]="TIMEEND",e[e.ERROR=6]="ERROR",e[e.NONE=7]="NONE"})(Ye||(Ye={}));var xt=typeof window<"u"&&typeof window.expect<"u",o=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanUp(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:{console.log(t,...i);break}case 1:{console.debug(t,...i);break}case 2:{console.info(t,...i);break}case 3:{console.warn(t,...i);break}case 6:{console.error(t,...i);break}case 4:{performance.mark(i[0]);break}case 5:{let s=i[0];try{let r=performance.measure(s,s);this.log(1,t,s,r?.duration),performance.clearMarks(s),performance.clearMeasures(s)}catch(r){this.log(1,t,s,r)}break}}}};o.level=xt?7:0;var Z;(function(e){e.RECORDING_STATE_UPDATED="RECORDING_STATE_UPDATED",e.BROWSER_RECORDING_STATE_UPDATED="BROWSER_RECORDING_STATE_UPDATED",e.SERVER_RECORDING_STATE_UPDATED="SERVER_RECORDING_STATE_UPDATED",e.RTMP_STREAMING_STATE_UPDATED="RTMP_STREAMING_STATE_UPDATED",e.HLS_STREAMING_STATE_UPDATED="HLS_STREAMING_STATE_UPDATED"})(Z||(Z={}));var B;(function(e){e[e.PEER_JOINED=0]="PEER_JOINED",e[e.PEER_LEFT=1]="PEER_LEFT",e[e.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",e[e.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",e[e.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",e[e.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",e[e.STARTED_SPEAKING=6]="STARTED_SPEAKING",e[e.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",e[e.ROLE_UPDATED=8]="ROLE_UPDATED",e[e.PEER_LIST=9]="PEER_LIST",e[e.NAME_UPDATED=10]="NAME_UPDATED",e[e.METADATA_UPDATED=11]="METADATA_UPDATED"})(B||(B={}));var D;(function(e){e[e.TRACK_ADDED=0]="TRACK_ADDED",e[e.TRACK_REMOVED=1]="TRACK_REMOVED",e[e.TRACK_MUTED=2]="TRACK_MUTED",e[e.TRACK_UNMUTED=3]="TRACK_UNMUTED",e[e.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",e[e.TRACK_DEGRADED=5]="TRACK_DEGRADED",e[e.TRACK_RESTORED=6]="TRACK_RESTORED"})(D||(D={}));var Qe;(function(e){e[e.DEFAULT=0]="DEFAULT"})(Qe||(Qe={}));var G;(function(e){e.NONE="none",e.LOW="low",e.MEDIUM="medium",e.HIGH="high"})(G||(G={}));var Vt={f:G.HIGH,h:G.MEDIUM,q:G.LOW},Pe;(function(e){e.VP8="vp8",e.VP9="vp9",e.H264="h264"})(Pe||(Pe={}));var Ce;(function(e){e.OPUS="opus"})(Ce||(Ce={}));var y;(function(e){e.audio="audio",e.video="video"})(y||(y={}));var x;(function(e){e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe"})(x||(x={}));var E={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},InitAPIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},m=class extends Error{constructor(e,t,i,s,r,n=!1){super(s),this.code=e,this.name=t,this.message=s,this.description=r,this.isTerminal=n,Object.setPrototypeOf(this,m.prototype),this.action=i.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{
      code: ${this.code};
      name: ${this.name};
      action: ${this.action};
      message: ${this.message};
      description: ${this.description};
      isTerminal: ${this.isTerminal};
      nativeError: ${(e=this.nativeError)==null?void 0:e.message};
    }`}},g;(function(e){e.NONE="NONE",e.TRACK="TRACK",e.INIT="INIT",e.PUBLISH="PUBLISH",e.UNPUBLISH="UNPUBLISH",e.JOIN="JOIN",e.SUBSCRIBE="SUBSCRIBE",e.DATA_CHANNEL_SEND="DATA_CHANNEL_SEND",e.RESTART_ICE="RESTART_ICE",e.VIDEO_PLUGINS="VIDEO_PLUGINS",e.AUDIO_PLUGINS="AUDIO_PLUGINS",e.AUTOPLAY="AUTOPLAY",e.RECONNECT_SIGNAL="RECONNECT_SIGNAL",e.VALIDATION="VALIDATION",e.PLAYLIST="PLAYLIST",e.PREVIEW="PREVIEW"})(g||(g={}));var p={WebSocketConnectionErrors:{FailedToConnect(e,t=""){return new m(E.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`)},WebSocketConnectionLost(e,t=""){return new m(E.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",e,"Network connection lost ",t)},AbnormalClose(e,t=""){return new m(E.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",e,"Websocket closed abnormally",t)}},InitAPIErrors:{ServerErrors(e,t,i=""){return new m(e,"ServerErrors",t,`[INIT]: Server error ${i}`,i,!0)},EndpointUnreachable(e,t=""){return new m(E.InitAPIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",e,`Endpoint is not reachable - ${t}`,t)},InvalidTokenFormat(e,t=""){return new m(E.InitAPIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0)},InitConfigNotAvailable(e,t=""){return new m(E.InitAPIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`)}},TracksErrors:{GenericTrack(e,t=""){return new m(E.TracksErrors.GENERIC_TRACK,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`)},CantAccessCaptureDevice(e,t,i=""){return new m(E.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,i)},DeviceNotAvailable(e,t,i=""){return new m(E.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,i)},DeviceInUse(e,t,i=""){return new m(E.TracksErrors.DEVICE_IN_USE,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,i)},DeviceLostMidway(e,t,i=""){return new m(E.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",e,`Lost access to capture device midway - ${t}`,i)},NothingToReturn(e,t=""){return new m(E.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",e,"There is no media to return. Please select either video or audio or both.",t)},InvalidVideoSettings(e,t=""){return new m(E.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t)},AutoplayBlocked(e,t=""){return new m(E.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t)},CodecChangeNotPermitted(e,t=""){return new m(E.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",e,"Codec can't be changed mid call.",t)},OverConstrained(e,t,i=""){return new m(E.TracksErrors.OVER_CONSTRAINED,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,i)},NoAudioDetected(e,t="Please check the mic or use another audio input"){return new m(E.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",e,"No audio input detected from microphone",t)},SystemDeniedPermission(e,t,i=""){return new m(E.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,i)}},WebrtcErrors:{CreateOfferFailed(e,t=""){return new m(E.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t)},CreateAnswerFailed(e,t=""){return new m(E.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t)},SetLocalDescriptionFailed(e,t=""){return new m(E.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t)},SetRemoteDescriptionFailed(e,t=""){return new m(E.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t)},ICEFailure(e,t=""){return new m(E.WebrtcErrors.ICE_FAILURE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t)}},WebsocketMethodErrors:{ServerErrors(e,t,i){return new m(e,"ServerErrors",t,i,i,!0)},AlreadyJoined(e,t=""){return new m(E.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t)},CannotJoinPreviewInProgress(e,t=""){return new m(E.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",e,"[JOIN]: Cannot join if preview is in progress",t)}},GenericErrors:{NotConnected(e,t=""){return new m(E.GenericErrors.NOT_CONNECTED,"NotConnected",e,"Client is not connected",t)},Signalling(e,t){return new m(E.GenericErrors.SIGNALLING,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t)},Unknown(e,t){return new m(E.GenericErrors.UNKNOWN,"Unknown",e,`Unknown exception: ${t}`,t)},NotReady(e,t=""){return new m(E.GenericErrors.NOT_READY,"NotReady",e,t,t)},JsonParsingFailed(e,t,i=""){return new m(E.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",e,`Failed to parse JSON message - ${t}`,i)},TrackMetadataMissing(e,t=""){return new m(E.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",e,"Track Metadata Missing",t)},RTCTrackMissing(e,t=""){return new m(E.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",e,"RTC Track missing",t)},PeerMetadataMissing(e,t=""){return new m(E.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",e,"Peer Metadata Missing",t)},ValidationFailed(e,t){return new m(E.GenericErrors.INVALID_ROLE,"ValidationFailed",g.VALIDATION,e,t?JSON.stringify(t):"")},InvalidRole(e,t){return new m(E.GenericErrors.INVALID_ROLE,"InvalidRole",e,"Invalid role. Join with valid role",t,!0)},PreviewAlreadyInProgress(e,t=""){return new m(E.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t)},MissingMediaDevices(){return new m(E.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices",g.JOIN,"navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0)},MissingRTCPeerConnection(){return new m(E.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection",g.JOIN,"RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)}},MediaPluginErrors:{PlatformNotSupported(e,t=""){return new m(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t)},InitFailed(e,t=""){return new m(7002,"InitFailed",e,"Plugin init failed",t)},ProcessingFailed(e,t=""){return new m(7003,"ProcessingFailed",e,"Plugin processing failed",t)},AddAlreadyInProgress(e,t=""){return new m(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t)},DeviceNotSupported(e,t=""){return new m(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t)}},PlaylistErrors:{NoEntryToPlay(e,t){return new m(E.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t)},NoEntryPlaying(e,t){return new m(E.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",e,"No entry is playing at this time",t)}}},ze="VALIDATIONS";function X(e){return e!=null}var Ze=()=>{if(!X(RTCPeerConnection)){let e=p.GenericErrors.MissingRTCPeerConnection();throw o.e(ze,e),e}},Xe=()=>{if(!X(navigator.mediaDevices)){let e=p.GenericErrors.MissingMediaDevices();throw o.e(ze,e),e}};function $t(e,t){var i;let s=Ar(e.sdp);if(!((i=s.origin)!=null&&i.username.startsWith("mozilla")))return e;let r=t?Array.from(t.values()):[];return s.media.forEach(n=>{var a,d,c;let h=(a=n.msid)==null?void 0:a.split(" ")[0],u=(d=r.find(v=>v.type===n.type&&v.stream_id===h))==null?void 0:d.track_id;u&&(n.msid=(c=n.msid)==null?void 0:c.replace(/\s(.+)/,` ${u}`))}),{type:e.type,sdp:hi(s)}}function Wt(e,t){var i;if(!e?.sdp||!t)return;let s=Ar(e.sdp).media.find(r=>X(r.mid)&&parseInt(r.mid)===parseInt(t));return(i=s?.msid)==null?void 0:i.split(" ")[1]}function Ht(e){return e.sdp.includes("usedtx=1")?e:{type:e.type,sdp:e.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}var j="HMSConnection",Os=class{constructor(e,t){this.candidates=new Array,this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return this.role===x.Publish?g.PUBLISH:g.SUBSCRIBE}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return l(this,null,function*(){try{let i=yield this.nativeConnection.createOffer(t);return o.d(j,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),Ht($t(i,e))}catch(i){throw p.WebrtcErrors.CreateOfferFailed(this.action,i.message)}})}createAnswer(e=void 0){return l(this,null,function*(){try{let t=yield this.nativeConnection.createAnswer(e);return o.d(j,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(t){throw p.WebrtcErrors.CreateAnswerFailed(this.action,t.message)}})}setLocalDescription(e){return l(this,null,function*(){try{o.d(j,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(t){throw p.WebrtcErrors.SetLocalDescriptionFailed(this.action,t.message)}})}setRemoteDescription(e){return l(this,null,function*(){try{o.d(j,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(t){throw p.WebrtcErrors.SetRemoteDescriptionFailed(this.action,t.message)}})}addIceCandidate(e){return l(this,null,function*(){o.d(j,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)})}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}logSelectedIceCandidatePairs(){(this.role===x.Publish?this.getSenders():this.getReceivers()).forEach(e=>{var t;let i=(t=e.track)==null?void 0:t.kind;try{if(e.transport){let s=e.transport.iceTransport,r=()=>{let n=s.getSelectedCandidatePair();o.d(j,`${x[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(n,null,2))};typeof s.onselectedcandidatepairchange=="function"&&(s.onselectedcandidatepairchange=r),r()}}catch(s){o.w(j,`Error in logging selected ice candidate pair for ${x[this.role]} connection`,s)}})}removeTrack(e){this.nativeConnection.removeTrack(e)}setMaxBitrate(e,t){return l(this,null,function*(){let i=this.getSenders().find(s=>{var r;return((r=s?.track)==null?void 0:r.id)===t.getTrackIDBeingSent()});if(i){let s=i.getParameters();s.encodings.length>0&&(s.encodings[0].maxBitrate=e*1e3),yield i.setParameters(s)}else o.w(j,`no sender found to setMaxBitrate for track - ${t.trackId}, sentTrackId - ${t.getTrackIDBeingSent()}`)})}getStats(){return l(this,null,function*(){return yield this.nativeConnection.getStats()})}close(){return l(this,null,function*(){this.nativeConnection.close()})}getReceivers(){return this.nativeConnection.getReceivers()}},ne="renegotiation-callback-id",et="ion-sfu",tt=100,be=5,Kt=60,jt=12e3,Jt=1e3,qt=5,ae="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",Yt=6e4,Qt=1e3,zt=!1,Zt="https://event.100ms.live/v2/client/report",Xt="https://event-nonprod.100ms.live/v2/client/report",ei=100,L={DEVICE_CHANGE:"device-change",LOCAL_AUDIO_ENABLED:"local-audio-enabled",LOCAL_VIDEO_ENABLED:"local-video-enabled",STATS_UPDATE:"stats-update",RTC_STATS_UPDATE:"rtc-stats-update",TRACK_DEGRADED:"track-degraded",TRACK_RESTORED:"track-restored",TRACK_AUDIO_LEVEL_UPDATE:"track-audio-level-update",LOCAL_AUDIO_SILENCE:"local-audio-silence",ANALYTICS:"analytics",AUDIO_PLUGIN_FAILED:"audio-plugin-failed",POLICY_CHANGE:"policy-change",LOCAL_ROLE_UPDATE:"local-role-update",AUDIO_TRACK_UPDATE:"audio-track-update",AUDIO_TRACK_ADDED:"audio-track-added",AUDIO_TRACK_REMOVED:"audio-track-removed",AUTOPLAY_ERROR:"autoplay-error"},ti="HMSPublishConnection",ii=class extends null{constructor(e,t,i,s){super(x.Publish,e),this.observer=i,this.transport=s,this.nativeConnection=new RTCPeerConnection(t),this.nativeConnection.createDataChannel(et,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:r})=>{r&&e.trickle(this.role,r)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>l(this,null,function*(){o.d(ti,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()})}trackUpdate(e){this.transport.trackUpdate(e)}},Ls=class{constructor(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id}},it=class extends null{constructor(e,t){super(e),this.audio=!0,this.video=G.NONE,this.connection=t}setAudio(e){this.audio!==e&&(this.audio=e,this.syncWithApiChannel(!1))}setVideoLayerLocally(e,t){this.video=e,o.d(`[Remote stream] ${t} - ${this.id}`,`Setting layer field to - ${e}`)}setVideoLayer(e,t){this.setVideoLayerLocally(e,t),o.d(`[Remote stream] ${t} - ${this.id}`,`Switching to ${e} layer`),this.syncWithApiChannel()}getSimulcastLayer(){return this.video}isAudioSubscribed(){return this.audio}syncWithApiChannel(e=!0){let t={streamId:this.id,audio:this.audio};e&&(t.video=this.video,t.framerate=this.video),this.connection.sendOverApiDataChannel(JSON.stringify(t))}},si=class{constructor(e,t,i=""){this.TAG="HMSDataChannel",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=s=>{this.observer.onMessage(s.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){o.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}},ge=e=>e?`{
    trackId: ${e.id};
    kind: ${e.kind};
    enabled: ${e.enabled};
    muted: ${e.muted};
    readyState: ${e.readyState};
  }`:"",ri=class{constructor(e,t,i){this.logIdentifier="",this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return l(this,null,function*(){this.nativeTrack.enabled=e})}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;(e=this.nativeTrack)==null||e.stop()}toString(){return`{
      streamId: ${this.stream.id};
      peerId: ${this.peerId};
      trackId: ${this.trackId};
      logIdentifier: ${this.logIdentifier};
      source: ${this.source};
      enabled: ${this.enabled};
      nativeTrack: ${ge(this.nativeTrack)};
    }`}},w;(function(e){e.AUDIO="audio",e.VIDEO="video"})(w||(w={}));var Ms=class extends null{constructor(e,t,i){if(super(e,t,i),this.type=w.AUDIO,this.audioElement=null,t.kind!=="audio")throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?this.audioElement.volume*100:null}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.subscribeToAudio(e===0?!1:this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}setAudioElement(e){this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return l(this,null,function*(){var t;if(!this.audioElement){o.d("audio-track","no audio element to set output");return}try{typeof this.audioElement.setSinkId=="function"&&(yield(t=this.audioElement)==null?void 0:t.setSinkId(e.deviceId),this.outputDevice=e)}catch(i){o.d("audio-track",i)}})}removeSink(){var e;this.audioElement&&((e=window.HMS)==null?void 0:e.AUDIO_SINK)&&(this.audioElement.srcObject=null,this.subscribeToAudio(!1))}addSink(){var e,t;if(!this.nativeTrack||!this.audioElement||!((e=window.HMS)!=null&&e.AUDIO_SINK))return;let i=this.audioElement.srcObject;i instanceof MediaStream&&((t=i.getAudioTracks()[0])==null?void 0:t.id)===this.nativeTrack.id||(this.audioElement.srcObject=new MediaStream([this.nativeTrack]),this.subscribeToAudio(!0))}subscribeToAudio(e){this.stream instanceof it&&this.stream.setAudio(e)}},ni=class extends null{setEnabled(e){var t=i=>super[i];return l(this,null,function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e),this.subscribeToAudio(e))})}},Us=class extends null{constructor(e,t,i){if(super(e,t,i),this.type=w.VIDEO,this.sinkCount=0,t.kind!=="video")throw new Error("Expected 'track' kind = 'video'")}hasSinks(){return this.sinkCount>0}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){e.srcObject!==null&&(e.srcObject=null,this.sinkCount>0&&this.sinkCount--)}addSinkInternal(e,t){var i;let s=e.srcObject;s!==null&&s instanceof MediaStream&&((i=s.getVideoTracks()[0])==null?void 0:i.id)===t.id||(e.srcObject=new MediaStream([t]),this.sinkCount++)}},Re=class extends null{constructor(){super(...arguments),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new ai}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(e){var t=i=>super[i];return l(this,null,function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e))})}preferLayer(e){!this.shouldSendVideoLayer(e,"preferLayer")||(this.stream.setVideoLayer(e,this.logIdentifier),this.pushInHistory(`uiPreferLayer-${e}`))}getSimulcastLayer(){return this.stream.getSimulcastLayer()}addSink(e){super.addSink(e),this.updateLayer("addSink"),this.pushInHistory("uiSetLayer-high")}removeSink(e){super.removeSink(e),this.updateLayer("removeSink"),this._degraded=!1,this.pushInHistory("uiSetLayer-none")}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e,t){this._degraded=t,this._degradedAt=t?new Date:this._degradedAt,this.stream.setVideoLayerLocally(e,this.logIdentifier),this.pushInHistory(`sfuLayerUpdate-${e}`)}setDegradedFromSdk(e){this._degraded=e,this._degradedAt=e?new Date:this._degradedAt,this.updateLayer("sdkDegradation"),this.pushInHistory(e?"sdkDegraded-none":"sdkRecovered-high")}updateLayer(e){let t=this.degraded||!this.hasSinks()?G.NONE:G.HIGH;!this.shouldSendVideoLayer(t,e)||this.stream.setVideoLayer(t,this.logIdentifier)}pushInHistory(e){zt&&this.history.push({name:e,layer:this.getSimulcastLayer(),degraded:this.degraded})}shouldSendVideoLayer(e,t){let i=this.getSimulcastLayer();return this.degraded&&e===G.NONE?!0:i===e?(o.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${t}`),!1):!0}},ai=class{constructor(){this.history=[]}push(e){e.time=new Date().toISOString().split("T")[1],this.history.push(e)}},oi=class extends null{constructor(e,t,i){super(x.Subscribe,e),this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.pendingMessageQueue=[],this.handlePendingApiMessages=()=>{this.pendingMessageQueue.length>0&&(o.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach(s=>this.sendOverApiDataChannel(s)),this.pendingMessageQueue.length=0)},this.observer=i,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===et&&(this.apiChannel=new si(e.channel,{onMessage:t=>{this.observer.onApiChannelMessage(t)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{e.candidate!==null&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var t;let i=e.streams[0],s=i.id;if(!this.remoteStreams.has(s)){let c=new it(i,this);this.remoteStreams.set(s,c),i.onremovetrack=h=>{let u=c.tracks.findIndex(v=>v.nativeTrack.id===h.track.id);if(u>=0){let v=c.tracks[u];this.observer.onTrackRemove(v),c.tracks.splice(u,1),c.tracks.length===0&&this.remoteStreams.delete(s)}}}let r=this.remoteStreams.get(s),n=e.track.kind==="audio"?ni:Re,a=new n(r,e.track),d=Wt(this.remoteDescription,(t=e.transceiver)==null?void 0:t.mid);d&&a.setSdpTrackId(d),r.tracks.push(a),this.observer.onTrackAdd(a)}}sendOverApiDataChannel(e){this.apiChannel&&this.apiChannel.readyState==="open"?this.apiChannel.send(e):(o.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}close(){var e=t=>super[t];return l(this,null,function*(){var t;yield e("close").call(this),(t=this.apiChannel)==null||t.close()})}},_e="InitService",li=class{static handleError(e,t){switch(e.status){case 404:throw p.InitAPIErrors.EndpointUnreachable(g.INIT,t.message||e.statusText);case 200:break;default:throw p.InitAPIErrors.ServerErrors(t.code||e.status,g.INIT,t.message||e?.statusText)}}static fetchInitConfig(e){return l(this,arguments,function*({token:t,peerId:i,userAgent:s,initEndpoint:r="https://prod-init.100ms.live",region:n=""}){o.d(_e,`fetchInitConfig: initEndpoint=${r} token=${t} peerId=${i} region=${n} `);let a=di(r,i,s,n);try{let d=yield fetch(a,{headers:{Authorization:`Bearer ${t}`}}),c=yield d.json();return this.handleError(d,c),o.d(_e,`config is ${JSON.stringify(c,null,2)}`),ci(c)}catch(d){let c=d;throw["Failed to fetch","NetworkError"].some(h=>c.message.includes(h))?p.InitAPIErrors.EndpointUnreachable(g.INIT,c.message):c}})}};function di(e,t,i,s){try{let r=new URL("/init",e);return s&&s.trim().length>0&&r.searchParams.set("region",s.trim()),r.searchParams.set("peer_id",t),r.searchParams.set("user_agent_v2",i),r.toString()}catch(r){let n=r;throw o.e(_e,n.name,n.message),n}}function ci(e){var t;return O(f({},e),{rtcConfiguration:O(f({},e.rtcConfiguration),{iceServers:(t=e.rtcConfiguration)==null?void 0:t.ice_servers})})}var A;(function(e){e.JOIN="join",e.OFFER="offer",e.ANSWER="answer",e.TRICKLE="trickle",e.TRACK_UPDATE="track-update",e.BROADCAST="broadcast",e.ANALYTICS="analytics",e.SERVER_ERROR="on-error",e.SERVER_WARNING="on-warning",e.SDK_NOTIFICATION="sdk-notification",e.LEAVE="leave",e.END_ROOM="end-room",e.PING="ping",e.ROLE_CHANGE_REQUEST="role-change-request",e.ROLE_CHANGE="role-change",e.TRACK_UPDATE_REQUEST="track-update-request",e.PEER_LEAVE_REQUEST="peer-leave-request",e.CHANGE_TRACK_MUTE_STATE_REQUEST="change-track-mute-state-request",e.START_RTMP_OR_RECORDING_REQUEST="rtmp-start",e.STOP_RTMP_AND_RECORDING_REQUEST="rtmp-stop",e.UPDATE_PEER_METADATA="peer-update",e.START_HLS_STREAMING="hls-start",e.STOP_HLS_STREAMING="hls-stop",e.HLS_TIMED_METADATA="hls-timed-metadata",e.SET_METADATA="set-metadata",e.GET_METADATA="get-metadata"})(A||(A={}));function ui(e){switch(e){case A.JOIN:return g.JOIN;case A.OFFER:return g.PUBLISH;case A.ANSWER:return g.SUBSCRIBE;case A.TRACK_UPDATE:return g.TRACK;default:return g.NONE}}var st=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function J(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise(t=>setTimeout(t,e))}var gi=class{constructor(e){this.TAG="[SIGNAL]: ",this.pongResponseTimes=new st(qt),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.onCloseHandler=()=>{},this.offlineListener=()=>{o.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")},this.onlineListener=()=>{o.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()},this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){o.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return l(this,null,function*(){var i;let s=vi(),r={method:e,params:t,id:s,jsonrpc:"2.0"};(i=this.socket)==null||i.send(JSON.stringify(r));try{return yield new Promise((n,a)=>{this.callbacks.set(s,{resolve:n,reject:a})})}catch(n){let a=n;throw p.WebsocketMethodErrors.ServerErrors(Number(a.code),ui(e),a.message)}})}notify(e,t){var i;let s={method:e,params:t};(i=this.socket)==null||i.send(JSON.stringify(s))}open(e){return new Promise((t,i)=>{let s=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let r=a=>{o.e(this.TAG,"Error from websocket",a),s=!0,i(p.WebSocketConnectionErrors.FailedToConnect(g.JOIN,`Error opening websocket connection - ${a}`))};this.onCloseHandler=a=>{o.e(`Websocket closed code=${a.code}`),s?this.setIsConnected(!1,`code: ${a.code}${a.code!==1e3?", unexpected websocket close":""}`):(s=!0,i(p.WebSocketConnectionErrors.AbnormalClose(g.JOIN,`Error opening websocket connection - websocket closed unexpectedly with code=${a.code}`)))},this.socket.addEventListener("error",r);let n=()=>{var a,d;s=!0,t(),this.setIsConnected(!0),this.id++,(a=this.socket)==null||a.removeEventListener("open",n),(d=this.socket)==null||d.removeEventListener("error",r),this.pingPongLoop(this.id)};this.socket.addEventListener("open",n),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)})}close(){return l(this,null,function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")})}join(e,t,i,s,r){return l(this,null,function*(){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost(g.JOIN,"Failed to send join over WS connection");let n={name:e,disableVidAutoSub:i,data:t,offer:r,server_sub_degrade:s},a=yield this.internalCall(A.JOIN,n);return this.isJoinCompleted=!0,this.pendingTrickle.forEach(({target:d,candidate:c})=>this.trickle(d,c)),this.pendingTrickle.length=0,o.d(this.TAG,`join: response=${JSON.stringify(a,null,1)}`),a})}trickle(e,t){this.isJoinCompleted?this.notify(A.TRICKLE,{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return l(this,null,function*(){return yield this.call(A.OFFER,{desc:e,tracks:Object.fromEntries(t)})})}answer(e){this.notify(A.ANSWER,{desc:e})}trackUpdate(e){this.notify(A.TRACK_UPDATE,{version:"1.0",tracks:Object.fromEntries(e)})}broadcast(e){return l(this,null,function*(){return yield this.call(A.BROADCAST,f({version:"1.0"},e.toSignalParams()))})}leave(){this.notify(A.LEAVE,{version:"1.0"})}endRoom(e,t){return l(this,null,function*(){yield this.call(A.END_ROOM,{lock:e,reason:t})})}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify(A.ANALYTICS,e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise(r=>{setTimeout(()=>{r(Date.now()-t)},e+1)}),s=this.internalCall(A.PING,{timestamp:t}).then(()=>Date.now()-t).catch(()=>Date.now()-t);return Promise.race([i,s])}requestRoleChange(e){return l(this,null,function*(){yield this.call(A.ROLE_CHANGE_REQUEST,e)})}acceptRoleChangeRequest(e){return l(this,null,function*(){yield this.call(A.ROLE_CHANGE,e)})}requestTrackStateChange(e){return l(this,null,function*(){yield this.call(A.TRACK_UPDATE_REQUEST,e)})}requestMultiTrackStateChange(e){return l(this,null,function*(){yield this.call(A.CHANGE_TRACK_MUTE_STATE_REQUEST,e)})}removePeer(e){return l(this,null,function*(){yield this.call(A.PEER_LEAVE_REQUEST,e)})}startRTMPOrRecording(e){return l(this,null,function*(){yield this.call(A.START_RTMP_OR_RECORDING_REQUEST,f({version:"1.0"},e))})}stopRTMPAndRecording(){return l(this,null,function*(){yield this.call(A.STOP_RTMP_AND_RECORDING_REQUEST,{version:"1.0"})})}startHLSStreaming(e){return l(this,null,function*(){yield this.call(A.START_HLS_STREAMING,f({version:"1.0"},e))})}stopHLSStreaming(e){return l(this,null,function*(){yield this.call(A.STOP_HLS_STREAMING,f({version:"1.0"},e))})}sendHLSTimedMetadata(e){return l(this,null,function*(){yield this.call(A.HLS_TIMED_METADATA,f({version:"1.0"},e))})}updatePeer(e){return l(this,null,function*(){yield this.call(A.UPDATE_PEER_METADATA,f({version:"1.0"},e))})}setSessionMetadata(e){return l(this,null,function*(){yield this.call(A.SET_METADATA,f({version:"1.0"},e))})}getSessionMetadata(){return this.call(A.GET_METADATA,{version:"1.0"})}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(i.id)this.handleResponseWithId(i);else if(i.method)this.handleResponseWithMethod(i);else throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`)}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let s=this.callbacks.get(i);this.callbacks.delete(i),t.result?s.resolve(t.result):s.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case A.OFFER:this.observer.onOffer(e.params);break;case A.TRICKLE:this.observer.onTrickle(e.params);break;case A.SERVER_ERROR:this.observer.onServerError(p.WebsocketMethodErrors.ServerErrors(Number(e.params.code),g.NONE,e.params.message));break;case A.SERVER_WARNING:o.w(this.TAG,e.params);break;default:this.observer.onNotification(e);break}}pingPongLoop(e){return l(this,null,function*(){var t,i;let s=((t=window.HMS)==null?void 0:t.PING_TIMEOUT)||jt;if(this.isConnected){let r=yield this.ping(s);this.pongResponseTimes.enqueue(r),r>s?(o.d(this.TAG,`Pong timeout ${e}, pageHidden=${Ft()}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout(()=>this.pingPongLoop(e),((i=window.HMS)==null?void 0:i.PING_INTERVAL)||Jt)}})}call(e,t){return l(this,null,function*(){let i=3,s=p.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);for(let r=0;r<i;r++)try{return o.d(this.TAG,`Try number ${r+1} sending ${e}`,t),yield this.internalCall(e,t)}catch(n){if(s=n,o.e(this.TAG,`Failed sending ${e}`,{method:e,try:r+1,params:t,error:s}),!(parseInt(`${s.code/100}`)===5||s.code===429))break;let a=(2+Math.random()*2)*1e3;yield J(a)}throw o.e(`Sending ${e} over WS failed after ${i} retries`,{method:e,params:t,error:s}),s})}},se=class{constructor(){this._volume=1,this._codec=Ce.OPUS,this._maxBitrate=32,this._deviceId="default",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new De(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},De=class{constructor(e,t,i,s,r){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=s,this.advanced=r}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},q=class{constructor(){this._width=320,this._height=180,this._codec=Pe.VP8,this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if(typeof e=="number"&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new we(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate)}},we=class{constructor(e,t,i,s,r,n,a){this.width=e,this.height=t,this.codec=i,this.maxFramerate=s,this.maxBitrate=a,this.deviceId=r,this.advanced=n}toConstraints(){return{width:this.width,height:this.height,frameRate:this.maxFramerate,deviceId:this.deviceId}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec}}},rt=class{constructor(){this._video=new q().build(),this._audio=new se().build(),this._screen=new q().build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(this._audio===null&&this._video===null)throw p.TracksErrors.NothingToReturn(g.TRACK);if(this._video===null&&this._simulcast)throw p.TracksErrors.InvalidVideoSettings(g.TRACK,"Cannot enable simulcast when no video settings are provided");return new Ne(this._video,this._audio,this._simulcast,this._screen||void 0)}},Ne=class{constructor(e,t,i,s=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=s}toAnalyticsProperties(){let e={audio_enabled:this.audio!==null,video_enabled:this.video!==null};return this.audio&&(e=f(f({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=f(f({},this.video.toAnalyticsProperties()),e)),e}},S;(function(e){e.ROOM_STATE="room-state",e.PEER_JOIN="on-peer-join",e.PEER_LEAVE="on-peer-leave",e.PEER_LIST="peer-list",e.TRACK_METADATA_ADD="on-track-add",e.TRACK_UPDATE="on-track-update",e.CHANGE_TRACK_MUTE_STATE_UPDATE="on-change-track-mute-state-request",e.ACTIVE_SPEAKERS="active-speakers",e.CONNECTION_QUALITY="on-connection-quality-update",e.SFU_STATS="sfu-stats",e.ON_SFU_TRACK_LAYER_UPDATE="on-track-layer-update",e.BROADCAST="on-broadcast",e.ROLE_CHANGE="on-role-change",e.POLICY_CHANGE="on-policy-change",e.ROLE_CHANGE_REQUEST="on-role-change-request",e.TRACK_UPDATE_REQUEST="on-track-update-request",e.PEER_UPDATE="on-peer-update",e.PEER_LEAVE_REQUEST="on-peer-leave-request",e.UNSUPPORTED="unsupported",e.RTMP_START="on-rtmp-start",e.RTMP_STOP="on-rtmp-stop",e.RECORDING_START="on-record-start",e.RECORDING_STOP="on-record-stop",e.HLS_START="on-hls-start",e.HLS_STOP="on-hls-stop"})(S||(S={}));var pi=class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var t,i,s;let r=e["speaker-list"],n=r.map(d=>({audioLevel:d.level,peer:this.store.getPeerById(d.peer_id),track:this.store.getTrackById(d.track_id)}));(t=this.audioListener)==null||t.onAudioLevelUpdate(n),this.store.updateSpeakers(n);let a=r[0];if(a){let d=this.store.getPeerById(a.peer_id);(i=this.listener)==null||i.onPeerUpdate(B.BECAME_DOMINANT_SPEAKER,d)}else(s=this.listener)==null||s.onPeerUpdate(B.RESIGNED_DOMINANT_SPEAKER,null)}},nt=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:s,recipientRoles:r,time:n}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=s,this.recipientRoles=r,this.time=n}toSignalParams(){var e,t;let i=(e=this.recipientRoles)==null?void 0:e.map(n=>n.name),s=(t=this.recipientPeer)==null?void 0:t.peerId,r={info:{message:this.message,type:this.type}};return i?.length&&(r.roles=i),s&&(r.peer_id=s),r}toString(){var e;return`{
      sender: ${this.sender};
      recipientPeer: ${this.recipientPeer};
      recipientRoles: ${(e=this.recipientRoles)==null?void 0:e.map(t=>t.name)};
      message: ${this.message};
      time: ${this.time};
      type: ${this.type};
    }`}},mi=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:s,metadata:r,role:n,joinedAt:a}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=s,this.metadata=r,this.joinedAt=a,n&&(this.role=n)}updateRole(e){this.role=e}updateName(e){this.name=e}updateMetadata(e){this.metadata=e}toString(){var e;return`{
      name: ${this.name};
      role: ${(e=this.role)==null?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
    }`}},at=class{};at.makePeerId=()=>(0,Ie.Z)();var Ti=class extends null{constructor(e){super(O(f({},e),{peerId:at.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[]}},Ei=class extends null{constructor(e){super(O(f({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},fi=class{constructor(e,t){this.store=e,this.listener=t}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){e===S.BROADCAST&&this.handleBroadcast(t)}handleBroadcast(e){var t;let i=e.peer,s=e.info,r=e.roles,n=this.getSender(i),a=e.private?this.store.getLocalPeer():void 0,d=[];if(r?.length){let h=this.store.getKnownRoles();for(let u of r)h[u]&&d.push(h[u])}let c=new nt(O(f({},s),{sender:n,recipientRoles:d,recipientPeer:a,time:new Date(e.timestamp)}));o.d(this.TAG,`Received Message from sender=${i?.peer_id}: ${c}`),(t=this.listener)==null||t.onMessageReceived(c)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=new mi({peerId:e.peer_id,name:e.info.name,isLocal:!1,customerUserId:e.info.user_id,metadata:e.info.data})),t}},ki=class{constructor(e,t,i,s){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=s,this.handleInitialPeerList=r=>{let n=Object.values(r.peers);this.peerManager.handlePeerList(n)},this.handleReconnectPeerList=r=>{this.handleRepeatedPeerList(r.peers)},this.handlePreviewRoomState=r=>{if(!this.store.hasRoleDetailsArrived())return;let n=r.peers;if(n==null){r.peer_count===0&&this.handleRepeatedPeerList({});return}Object.keys(n).forEach(a=>{n[a].tracks={},n[a].is_from_room_state=!0}),this.handleRepeatedPeerList(n)},this.handleRepeatedPeerList=r=>{let n=this.store.getRemotePeers(),a=Object.values(r),d=n.filter(c=>!r[c.peerId]);o.d(this.TAG,`${d}`),d.forEach(c=>{var h;let u={peer_id:c.peerId,role:((h=c.role)==null?void 0:h.name)||"",info:{name:c.name,data:c.metadata||"",user_id:c.customerUserId||""},tracks:{}};this.peerManager.handlePeerLeave(u)}),a.forEach(c=>{let h=this.store.getPeerById(c.peer_id),u=Object.values(c.tracks);h?(this.store.getPeerTracks(h.peerId).forEach(v=>{var T;c.tracks[v.trackId]||(this.removePeerTrack(h,v.trackId),(T=this.listener)==null||T.onTrackUpdate(D.TRACK_REMOVED,v,h))}),u.forEach(v=>{this.store.getTrackById(v.track_id)||this.store.setTrackState({peerId:h.peerId,trackInfo:v})}),this.trackManager.handleTrackUpdate({peer:{info:c.info,peer_id:c.peer_id},tracks:c.tracks}),this.peerManager.handlePeerUpdate(c)):this.peerManager.handlePeerJoin(c)})}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t,i){if(e===S.PEER_LIST){let s=t;i?(o.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(s,null,2)),this.handleReconnectPeerList(s)):(o.d(this.TAG,"PEER_LIST event",JSON.stringify(s,null,2)),this.handleInitialPeerList(s))}else if(e===S.ROOM_STATE){let s=t;this.handlePreviewRoomState(s)}}removePeerTrack(e,t){var i,s;if(((i=e.audioTrack)==null?void 0:i.trackId)===t)e.audioTrack=void 0;else if(((s=e.videoTrack)==null?void 0:s.trackId)===t)e.videoTrack=void 0;else{let r=e.auxiliaryTracks.findIndex(n=>n.trackId===t);r>=0&&e.auxiliaryTracks.splice(r,1)}}},$=e=>e?new Date(e):void 0,yi=class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.handlePeerList=s=>{var r,n;if(s.length===0){(r=this.listener)==null||r.onPeerUpdate(B.PEER_LIST,[]);return}let a=[],d=new Set(s.map(c=>c.peer_id));this.store.getRemotePeers().forEach(({peerId:c,fromRoomState:h})=>{!d.has(c)&&h&&this.store.removePeer(c)});for(let c of s)a.push(this.makePeer(c));(n=this.listener)==null||n.onPeerUpdate(B.PEER_LIST,a),this.trackManager.processPendingTracks()},this.handlePeerJoin=s=>{var r;let n=this.makePeer(s);(r=this.listener)==null||r.onPeerUpdate(B.PEER_JOINED,n),this.trackManager.processPendingTracks()},this.handlePeerLeave=s=>{var r,n,a,d;let c=this.store.getPeerById(s.peer_id);this.store.removePeer(s.peer_id),o.d(this.TAG,"PEER_LEAVE",s.peer_id,`remainingPeers=${this.store.getPeers().length}`),c&&(c.audioTrack&&((r=this.listener)==null||r.onTrackUpdate(D.TRACK_REMOVED,c.audioTrack,c)),c.videoTrack&&((n=this.listener)==null||n.onTrackUpdate(D.TRACK_REMOVED,c.videoTrack,c)),(a=c.auxiliaryTracks)==null||a.forEach(h=>{var u;(u=this.listener)==null||u.onTrackUpdate(D.TRACK_REMOVED,h,c)}),(d=this.listener)==null||d.onPeerUpdate(B.PEER_LEFT,c))}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){switch(e){case S.PEER_JOIN:{let i=t;this.handlePeerJoin(i);break}case S.PEER_LEAVE:{let i=t;this.handlePeerLeave(i);break}case S.PEER_UPDATE:this.handlePeerUpdate(t);break;default:break}}handlePeerUpdate(e){var t;let i=this.store.getPeerById(e.peer_id);if(i){if(i.role&&i.role.name!==e.role){let s=this.store.getPolicyForRole(e.role);i.updateRole(s),(t=this.listener)==null||t.onPeerUpdate(B.ROLE_UPDATED,i)}this.handlePeerInfoUpdate(f({peer:i},e.info))}}handlePeerInfoUpdate({peer:e,name:t,data:i}){var s,r;!e||(t&&e.name!==t&&(e.updateName(t),(s=this.listener)==null||s.onPeerUpdate(B.NAME_UPDATED,e)),i&&e.metadata!==i&&(e.updateMetadata(i),(r=this.listener)==null||r.onPeerUpdate(B.METADATA_UPDATED,e)))}makePeer(e){let t=new Ei({peerId:e.peer_id,name:e.info.name,customerUserId:e.info.user_id,metadata:e.info.data,role:this.store.getPolicyForRole(e.role),joinedAt:$(e.joined_at),fromRoomState:!!e.is_from_room_state});this.store.addPeer(t),o.d(this.TAG,"adding to the peerList",t.toString());for(let i in e.tracks)this.store.setTrackState({peerId:e.peer_id,trackInfo:e.tracks[i]});return t}},Si=class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){var t;let i=this.store.getLocalPeer();if(i&&!i.role){let r=e.known_roles[e.name];i.updateRole(r)}this.store.setKnownRoles(e.known_roles),this.store.getRoom().templateId=e.template_id;let s=(t=e.known_roles[e.name])==null?void 0:t.publishParams;if(this.store.setPublishParams(s),this.setSimulcastLayers(s),i?.role&&i.role.name!==e.name){let r=this.store.getPolicyForRole(e.name),n=i.role;i.updateRole(r),this.eventBus.localRoleUpdate.publish({oldRole:n,newRole:r})}this.eventBus.policyChange.publish(e)}setSimulcastLayers(e){if(e&&Object.keys(e).length>0){let{videoSimulcastLayers:t,screenSimulcastLayers:i}=e;this.store.setVideoSimulcastLayers(t),this.store.setScreenshareSimulcastLayers(i)}}},Ai=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case S.ROLE_CHANGE_REQUEST:this.handleRoleChangeRequest(t);break;case S.TRACK_UPDATE_REQUEST:this.handleTrackUpdateRequest(t);break;case S.CHANGE_TRACK_MUTE_STATE_UPDATE:this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var t;let i={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};(t=this.listener)==null||t.onRoleChangeRequest(i)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:s}=e,r=t?this.store.getPeerById(t):void 0,n=this.store.getLocalPeerTracks().find(d=>d.publishedTrackId===i);if(!n)return;let a=()=>{var d;(d=this.listener)==null||d.onChangeTrackStateRequest({requestedBy:r,track:n,enabled:!s})};if(s){if(n.enabled===!s)return;n.setEnabled(!s).then(a)}else a()}handleChangeTrackStateRequest(e){var t;let{type:i,source:s,value:r,requested_by:n}=e,a=n?this.store.getPeerById(n):void 0,d=!r,c=this.getTracksToBeUpdated({type:i,source:s,enabled:d});if(c.length!==0)if(d)(t=this.listener)==null||t.onChangeMultiTrackStateRequest({requestedBy:a,tracks:c,type:i,source:s,enabled:!0});else{let h=[];for(let u of c)h.push(u.setEnabled(!1));Promise.all(h).then(()=>{var u;(u=this.listener)==null||u.onChangeMultiTrackStateRequest({requestedBy:a,tracks:c,enabled:!1})})}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter(r=>r.type===e)),t&&(s=s.filter(r=>r.source===t)),s.filter(r=>r.enabled!==i)}},Ii=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="RoomUpdateManager"}handleNotification(e,t){switch(e){case S.PEER_LIST:this.onRoomState(t.room);break;case S.RTMP_START:this.onRTMPStart(t);break;case S.RTMP_STOP:this.onRTMPStop(t);break;case S.RECORDING_START:this.onRecordingStart(t);break;case S.RECORDING_STOP:this.onRecordingStop(t);break;case S.ROOM_STATE:this.handlePreviewRoomState(t);break;default:this.onHLS(e,t);break}}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t,e.peer_count)}onRoomState(e,t){var i,s,r;let{recording:n,streaming:a,session_id:d,started_at:c,name:h}=e,u=this.store.getRoom();u.peerCount=t,u.name=h,u.recording.server.running=!!n?.sfu.enabled,u.recording.browser.running=!!n?.browser.enabled,u.rtmp.running=!!((i=a?.rtmp)!=null&&i.enabled),u.rtmp.startedAt=$((s=a?.rtmp)==null?void 0:s.started_at),u.recording.server.startedAt=$(n?.sfu.started_at),u.recording.browser.startedAt=$(n?.browser.started_at),u.recording.hls=this.getPeerListHLSRecording(n),u.hls=this.convertHls(a?.hls),u.sessionId=d,u.startedAt=$(c),(r=this.listener)==null||r.onRoomUpdate(Z.RECORDING_STATE_UPDATED,u)}onRTMPStart(e){var t;this.setRTMPStatus(!((t=e.error)!=null&&t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!((t=e.error)!=null&&t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}onHLS(e,t){var i,s;if(![S.HLS_START,S.HLS_STOP].includes(e))return;let r=this.store.getRoom();t.enabled=e===S.HLS_START&&!((i=t.error)!=null&&i.code),r.hls=this.convertHls(t),r.recording.hls=this.getHLSRecording(t),(s=this.listener)==null||s.onRoomUpdate(Z.HLS_STREAMING_STATE_UPDATED,r)}convertHls(e){var t;let i={running:!!e?.enabled,variants:[],error:this.toSdkError(e?.error)};return(t=e?.variants)==null||t.forEach(s=>{i.variants.push({meetingURL:s.meeting_url,url:s.url,metadata:s.metadata,startedAt:$(s.started_at)})}),i}getHLSRecording(e){var t,i,s;let r={running:!1};return e?.hls_recording&&(r={running:!!e?.enabled,singleFilePerLayer:!!((t=e.hls_recording)!=null&&t.single_file_per_layer),hlsVod:!!((i=e.hls_recording)!=null&&i.hls_vod),startedAt:$((s=e?.variants)==null?void 0:s[0].started_at),error:this.toSdkError(e.error)}),r}getPeerListHLSRecording(e){var t,i;let s=e?.hls;return{running:!!s?.enabled,startedAt:$(s?.started_at),singleFilePerLayer:!!((t=s?.config)!=null&&t.single_file_per_layer),hlsVod:!!((i=s?.config)!=null&&i.hls_vod)}}setRecordingStatus(e,t){var i;let s=this.store.getRoom(),r;t.type==="sfu"?(s.recording.server={running:e,startedAt:e?$(t.started_at):void 0,error:this.toSdkError(t.error)},r=Z.SERVER_RECORDING_STATE_UPDATED):(s.recording.browser={running:e,startedAt:e?$(t.started_at):void 0,error:this.toSdkError(t.error)},r=Z.BROWSER_RECORDING_STATE_UPDATED),(i=this.listener)==null||i.onRoomUpdate(r,s)}setRTMPStatus(e,t){var i;let s=this.store.getRoom();s.rtmp={running:e,startedAt:e?$(t.started_at):void 0,error:this.toSdkError(t.error)},(i=this.listener)==null||i.onRoomUpdate(Z.RTMP_STREAMING_STATE_UPDATED,s)}toSdkError(e){if(!e?.code)return;let t=e.message||"error in streaming/recording",i=new m(e.code,"ServerErrors",g.NONE,t,t);return o.e(this.TAG,"error in streaming/recording",i),i}},V;(function(e){e.UNKNOWN="unknown(video or audio)",e.AUDIO="audio",e.VIDEO="video",e.AV="audio, video",e.SCREEN="screen"})(V||(V={}));function Pi(e,t){let i=e.toLowerCase();return i.includes("device not found")?p.TracksErrors.DeviceNotAvailable(g.TRACK,t,e):i.includes("permission denied")?p.TracksErrors.CantAccessCaptureDevice(g.TRACK,t,e):p.TracksErrors.GenericTrack(g.TRACK,e)}function Ci(e,t=""){if(xr.browserDetails.browser==="chrome"&&e.name==="NotAllowedError"&&e.message.includes("denied by system"))return p.TracksErrors.SystemDeniedPermission(g.TRACK,t,e.message);if(xr.browserDetails.browser==="firefox"&&e.name==="NotFoundError"){let i=p.TracksErrors.SystemDeniedPermission(g.TRACK,t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return p.TracksErrors.OverConstrained(g.TRACK,t,e.constraint);case"NotAllowedError":return p.TracksErrors.CantAccessCaptureDevice(g.TRACK,t,e.message);case"NotFoundError":return p.TracksErrors.DeviceNotAvailable(g.TRACK,t,e.message);case"NotReadableError":return p.TracksErrors.DeviceInUse(g.TRACK,t,e.message);case"TypeError":return p.TracksErrors.NothingToReturn(g.TRACK,e.message);default:return Pi(e.message,t)}}function ee(e,t){let i=Ci(e,t);return i.addNativeError(e),i}function ot(e){return l(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:e?e.toConstraints():!1})).getAudioTracks()[0]}catch(t){throw ee(t,V.AUDIO)}})}function lt(e){return l(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:e?e.toConstraints():!1})).getVideoTracks()[0]}catch(t){throw ee(t,V.VIDEO)}})}function Oe(e){return"canvas"in e||e.label==="MediaStreamAudioDestinationNode"||e.label===""}var bi=35,Ri=5,_i=class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new st(this.historyInterval/this.interval),this.detectSilence=()=>l(this,null,function*(){let s=30,r=10,n=0;for(;this.isMonitored;){if(this.track.enabled)if(this.isSilentThisInstant()){if(n++,n>r){this.silenceEvent.publish({track:this.track});break}}else break;yield J(s)}});try{let s=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(s)}catch(s){o.w(this.TAG,"Unable to initialize AudioContext",s)}}start(){this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then(()=>o.d(this.TAG,"Stopping track Monitor",`${this.track}`))}stop(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}this.sendAudioLevel(0),this.isMonitored=!1}loop(){return l(this,null,function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield J(this.interval)})}sendAudioLevel(e=0){if(e=e>bi?e:0,Math.abs(this.audioLevel-e)>Ri){this.audioLevel=e;let t={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(t)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=this.calculateAudioLevel();return e!==void 0&&this.history.enqueue(e),this.history.aggregate(t=>Math.max(...t))}calculateAudioLevel(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let r of e)i=Math.max(i,(r-128)/128);let s=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(s*100,0),100))}isSilentThisInstant(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some(t=>t!==128&&t!==0)}createAnalyserNodeForStream(e){let t=new AudioContext,i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}},Le;(function(e){e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE"})(Le||(Le={}));var te;(function(e){e.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",e.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED"})(te||(te={}));var ie;(function(e){e.CUSTOM="CUSTOM",e.LOCAL="LOCAL",e.HMS="HMS"})(ie||(ie={}));function wi(){if(ve&&window){let e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"?ie.LOCAL:e.includes("app.100ms.live")?ie.HMS:ie.CUSTOM}return ie.CUSTOM}var pe=wi(),dt=Ot().version;function Me(e=F.PROD,t){let i="web",s=pe!==ie.LOCAL&&e===F.PROD?"prod":"debug";if(he)return ct({os:"web_nodejs",os_version:process.version,sdk:i,sdk_version:dt,env:s,domain:pe,framework:"node",framework_version:process.version,framework_sdk_version:t?.sdkVersion});let r=re.getOS(),n=re.getDevice(),a=re.getBrowser(),d=Ue(`web_${r.name}`),c=r.version||"",h=Ue(`${a.name}_${a.version}`),u=h;return n.type&&(u=`${Ue(`${n.vendor}_${n.type}`)}/${h}`),ct({os:d,os_version:c,sdk:i,sdk_version:dt,device_model:u,env:s,domain:pe,framework:t?.type,framework_version:t?.version,framework_sdk_version:t?.sdkVersion})}function Ue(e){return e.replace(/ /g,"_")}var ct=(e,t=",")=>Object.keys(e).filter(i=>!!e[i]).map(i=>`${i}:${e[i]}`).join(t),N=class{constructor({name:e,level:t,properties:i,includesPII:s,timestamp:r}){this.metadata={peer:{},userAgent:Me()},this.name=e,this.level=t,this.includesPII=s||!1,this.properties=i||{},this.timestamp=r||new Date().getTime(),this.event_id=(0,Ie.Z)(),this.device_id=Ut()}toSignalParams(){return{name:this.name,info:O(f({},this.properties),{timestamp:this.timestamp,domain:pe}),timestamp:new Date().getTime()}}},Fe;(function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"})(Fe||(Fe={}));var b;(function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"})(b||(b={}));var me=class{static failure(e,t){let i="mediaPlugin.failed",s=b.ERROR,r=f({plugin_name:e},t.toAnalyticsProperties());return new N({name:i,level:s,properties:r})}static audioPluginFailure(e,t,i){let s="mediaPlugin.failed",r=b.ERROR,n=f({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new N({name:s,level:r,properties:n})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:s}){let r="mediaPlugin.stats",n=b.INFO,a={plugin_name:e,duration:t,load_time:i,sampleRate:s};return new N({name:r,level:n,properties:a})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:s,avgProcessingTime:r,inputFrameRate:n,pluginFrameRate:a}){let d="mediaPlugin.stats",c=b.INFO,h={plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:s,avg_processing_time:r,input_frame_rate:n,plugin_frame_rate:a};return new N({name:d,level:c,properties:h})}},Ge="AudioPluginsAnalytics",Li=class{constructor(e){this.eventBus=e,this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(me.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(me.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return l(this,null,function*(){if(this.initTime[e]){o.i(Ge,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),o.i(Ge,`Time taken for Plugin ${e} initialization : ${i}`)}catch(s){let r=p.MediaPluginErrors.InitFailed(g.AUDIO_PLUGINS,`failed during initialization of plugin${s.message||s}`);throw o.e(Ge,r),this.failure(e,r),r}i&&(this.initTime[e]=i)})}timeInMs(e){return l(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}},H="AudioPluginsManager",Mi=48e3,Ui=()=>navigator.userAgent.indexOf("Firefox")!==-1,Fi=class{constructor(e,t){this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new Li(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return l(this,null,function*(){var t;let i=(t=e.getName)==null?void 0:t.call(e);if(!i){o.w("no name provided by the plugin");return}if(this.pluginAddInProgress){let s=p.MediaPluginErrors.AddAlreadyInProgress(g.AUDIO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.added(i,this.audioContext.sampleRate),this.analytics.failure(i,s),o.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e){return l(this,null,function*(){var t;let i=(t=e.getName)==null?void 0:t.call(e);if(this.pluginsMap.get(i)){o.w(H,`plugin - ${i} already added.`);return}yield this.validateAndThrow(i,e);try{this.pluginsMap.size===0?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(i,this.audioContext.sampleRate),yield this.analytics.initWithTime(i,()=>l(this,null,function*(){return e.init()})),this.pluginsMap.set(i,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(s){throw o.e(H,"failed to add plugin",s),s}})}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return l(this,null,function*(){let i=this.validatePlugin(t);if(i.isSupported)o.i(H,`plugin is supported,- ${t.getName()}`);else if(this.analytics.added(e,this.audioContext.sampleRate),i.errType===te.PLATFORM_NOT_SUPPORTED){let s=p.MediaPluginErrors.PlatformNotSupported(g.AUDIO_PLUGINS,"platform not supported, see docs");throw this.analytics.failure(e,s),yield this.cleanup(),s}else if(i.errType===te.DEVICE_NOT_SUPPORTED){let s=p.MediaPluginErrors.DeviceNotSupported(g.AUDIO_PLUGINS,"audio device not supported, see docs");throw this.analytics.failure(e,s),yield this.cleanup(),s}})}removePlugin(e){return l(this,null,function*(){yield this.removePluginInternal(e),this.pluginsMap.size===0?(yield this.cleanup(),o.i(H,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()})}cleanup(){return l(this,null,function*(){var e,t,i;for(let s of this.pluginsMap.values())yield this.removePluginInternal(s);yield this.hmsTrack.setProcessedTrack(void 0),(e=this.sourceNode)==null||e.disconnect(),(t=this.prevAudioNode)==null||t.disconnect(),(i=this.outputTrack)==null||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0})}closeContext(){return l(this,null,function*(){var e;(e=this.audioContext)==null||e.close(),this.audioContext=void 0})}reprocessPlugins(){return l(this,null,function*(){if(this.pluginsMap.size===0||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)})}initAudioNodes(){return l(this,null,function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw o.e(H,"error in setting processed track",e),e}}}})}processPlugin(e){return l(this,null,function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();o.e(H,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}})}connectToDestination(){return l(this,null,function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){o.e(H,"error in connecting to destination node",e)}})}removePluginInternal(e){return l(this,null,function*(){var t;let i=(t=e.getName)==null?void 0:t.call(e);if(!this.pluginsMap.get(i)){o.w(H,`plugin - ${i} not found to remove.`);return}o.i(H,`removing plugin ${i}`),this.pluginsMap.delete(i),e.stop(),this.analytics.removed(i)})}createAudioContext(){this.audioContext||(Ui()?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:Mi}))}},Gi=class{constructor(){this.storage=new ue("hms-device-selection"),this.remember=!1,this.TAG="HMSDeviceStorage"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let s=this.devices[e].find(n=>this.isSame({deviceId:t,groupId:i},n));if(!s){o.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);return}let r=this.storage.get()||{};r[e]=s,this.storage.set(r)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},Y=new Gi;function ut(e,t){return function(i){return i in e&&e[i]!==t[i]}}var Bi="HMSLocalAudioTrack",Be=class extends null{constructor(e,t,i,s,r=new se().build()){super(e,t,i),this.eventBus=s,this.handleSettingsChange=n=>l(this,null,function*(){let a=this.stream,d=ut(n,this.settings);d("maxBitrate")&&n.maxBitrate&&(yield a.setMaxBitrate(n.maxBitrate,this)),d("advanced")&&(yield this.nativeTrack.applyConstraints(n.toConstraints()))}),this.handleDeviceChange=(n,a=!1)=>l(this,null,function*(){ut(n,this.settings)("deviceId")&&(yield this.replaceTrackWith(n),a||Y.updateSelection("audioInput",{deviceId:n.deviceId,groupId:this.nativeTrack.getSettings().groupId}))}),e.tracks.push(this),this.settings=r,r.deviceId==="default"&&!Oe(t)&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Fi(this,s),this.setFirstTrackId(t.id)}replaceTrackWith(e){return l(this,null,function*(){let t=this.nativeTrack,i=this.enabled,s=Boolean(this.audioLevelMonitor);t?.stop();let r=yield ot(e);r.enabled=i;let n=this.stream;yield n.replaceSenderTrack(t,this.processedTrack||r),yield n.replaceStreamTrack(t,r),this.nativeTrack=r,s&&this.initAudioLevelMonitor();try{yield this.pluginsManager.reprocessPlugins()}catch(a){this.eventBus.audioPluginFailed.publish(a)}})}setEnabled(e){var t=i=>super[i];return l(this,null,function*(){e!==this.enabled&&(e&&Oe(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield t("setEnabled").call(this,e),e&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this))})}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return l(this,null,function*(){let i=this.buildNewSettings(e);if(yield this.handleDeviceChange(i,t),Oe(this.nativeTrack)){this.settings=i;return}yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return l(this,null,function*(){return this.pluginsManager.addPlugin(e)})}removePlugin(e){return l(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return l(this,null,function*(){if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),o.d(Bi,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new _i(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;(e=this.audioLevelMonitor)==null||e.stop(),this.audioLevelMonitor=void 0}cleanup(){var e=t=>super[t];return l(this,null,function*(){var t;e("cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),(t=this.processedTrack)==null||t.stop(),this.destroyAudioLevelMonitor()})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:t,codec:i,maxBitrate:s,deviceId:r,advanced:n}=f(f({},this.settings),e);return new De(t,i,s,r,n)}},oe;(function(e){e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE"})(oe||(oe={}));var xe;(function(e){e["2D"]="2d",e.WEBGL="webgl",e.WEBGL2="webgl2"})(xe||(xe={}));var ht=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},Te="VideoPluginsAnalytics",xi=class{constructor(e){this.eventBus=e,this.initTime={},this.preProcessingAvgs=new ht,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new ht,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:(t=this.processingAvgs[e])==null?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(me.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(me.failure(e,t)),this.clean(e))}initWithTime(e,t){return l(this,null,function*(){if(this.initTime[e]){o.i(Te,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),o.i(Te,`Time taken for Plugin ${e} initialization : ${i}`)}catch(s){let r=p.MediaPluginErrors.InitFailed(g.VIDEO_PLUGINS,`failed during initialization of plugin${s.message||s}`);throw o.e(Te,r),this.failure(e,r),r}i&&(this.initTime[e]=i)})}preProcessWithTime(e){return l(this,null,function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)})}processWithTime(e,t){return l(this,null,function*(){var i;let s;try{s=yield this.timeInMs(t)}catch(r){let n=p.MediaPluginErrors.ProcessingFailed(g.VIDEO_PLUGINS,`Failed during processing of plugin${r.message||r}`);throw o.e(Te,n),this.failure(e,n),n}s&&((i=this.processingAvgs[e])==null||i.add(s))})}timeInMs(e){return l(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}},vt=24,Vi=320,$i=240,U="VideoPluginsManager",Wi=class{constructor(e,t){this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new xi(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return l(this,null,function*(){var i;if(this.pluginAddInProgress){let s=(i=e.getName)==null?void 0:i.call(e);if(!s||s===""){o.w("no name provided by the plugin");return}let r=p.MediaPluginErrors.AddAlreadyInProgress(g.VIDEO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.failure(s,r),o.w("can't add another plugin when previous add is in progress"),r}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e,t){return l(this,null,function*(){var i,s;let r=(i=e.getName)==null?void 0:i.call(e);if(!r||r===""){o.w("no name provided by the plugin");return}if(this.pluginsMap.has(r)){o.w(U,`plugin - ${e.getName()} already added.`);return}let n=this.hmsTrack.getMediaTrackSettings().frameRate||vt,a=0;t&&t>0?(o.i(U,`adding plugin ${e.getName()} with framerate ${t}`),t<n&&(a=Math.ceil(n/t)-1),this.analytics.added(r,n,t)):(o.i(U,`adding plugin ${e.getName()}`),this.analytics.added(r,n)),o.i(U,"numFrames to skip processing",a),this.pluginNumFramesToSkip[r]=a,this.pluginNumFramesSkipped[r]=a,this.validateAndThrow(r,e);try{if(yield this.analytics.initWithTime(r,()=>l(this,null,function*(){return yield e.init()})),this.pluginsMap.set(r,e),this.pluginsMap.size+1>this.canvases.length)for(let d=this.canvases.length;d<=this.pluginsMap.size;d++)this.canvases[d]=document.createElement("canvas");yield this.startPluginsLoop((s=e.getContextType)==null?void 0:s.call(e))}catch(d){throw o.e(U,"failed to add plugin",d),yield this.removePlugin(e),d}})}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)o.i(U,`plugin is supported,- ${t.getName()}`);else{let s;switch(i.errType){case te.PLATFORM_NOT_SUPPORTED:throw s=p.MediaPluginErrors.PlatformNotSupported(g.VIDEO_PLUGINS,"platform not supported, see docs"),this.analytics.failure(e,s),s;case te.DEVICE_NOT_SUPPORTED:throw s=p.MediaPluginErrors.DeviceNotSupported(g.VIDEO_PLUGINS,"video device not supported, see docs"),this.analytics.failure(e,s),s}}}removePlugin(e){return l(this,null,function*(){let t=e.getName();if(!this.pluginsMap.get(t)){o.w(U,`plugin - ${t} not found to remove.`);return}o.i(U,`removing plugin ${t}`),this.removePluginEntry(t),this.pluginsMap.size===0&&(o.i(U,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)})}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return l(this,null,function*(){if(!(!this.pluginsLoopRunning||this.pluginsLoopState==="running"))for(;this.pluginsLoopState==="paused";)yield J(100)})}cleanup(){return l(this,null,function*(){var e;for(let t of this.pluginsMap.values())yield this.removePlugin(t);(e=this.outputTrack)==null||e.stop()})}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||xe["2D"]);let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return l(this,null,function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(t){throw this.pluginsLoopRunning=!1,o.e(U,"error in setting processed track",t),t}this.pluginsLoop().then(()=>{o.d(U,"processLoop stopped")})}})}stopPluginsLoop(){return l(this,null,function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),(e=this.outputTrack)==null||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)})}pluginsLoop(){return l(this,null,function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||vt,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||this.hmsTrack.nativeTrack.readyState==="ended"){this.pluginsLoopState==="running"&&this.resetCanvases(),this.pluginsLoopState="paused",yield J(t);continue}let i=0;try{yield this.analytics.preProcessWithTime(()=>l(this,null,function*(){return yield this.doPreProcessing()}));let s=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-s),i>t&&(i=t)}catch(s){o.e(U,"error in plugins loop",s)}this.pluginsLoopState="running",yield J(t-i)}})}doPreProcessing(){return l(this,null,function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()})}processFramesThroughPlugins(){return l(this,null,function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let s=this.checkIfSkipRequired(i);if(t.getPluginType()===oe.TRANSFORM){let r=(n,a)=>l(this,null,function*(){try{yield t.processVideoFrame(n,a,s)}catch(d){o.e(U,`error in processing plugin ${i}`,d)}});if(s)e===this.pluginsMap.size-1?yield r(this.canvases[e],this.outputCanvas):yield r(this.canvases[e],this.canvases[e+1]);else{let n=this.canvases[e],a=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,()=>l(this,null,function*(){return r(n,this.outputCanvas)})):yield this.analytics.processWithTime(i,()=>l(this,null,function*(){return r(n,a)}))}}else t.getPluginType()===oe.ANALYZE&&!s&&(yield this.analytics.processWithTime(i,()=>l(this,null,function*(){return yield t.processVideoFrame(this.inputCanvas)})))}catch(s){o.e(U,`error in processing plugin ${i}`,s),yield this.removePlugin(t)}e++}}})}addTrackToVideo(){return l(this,null,function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;t!==null&&t instanceof MediaStream&&((e=t.getVideoTracks()[0])==null?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())})}updateInputCanvas(){return l(this,null,function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=Vi,height:t=$i}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)})}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}},Ee="HMSLocalStream",fe=class extends null{constructor(){super(...arguments),this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let i=[];if(e instanceof ye)if(t.length>0)o.v(Ee,"Simulcast enabled with layers",t),i.push(...t);else{let r={active:this.nativeStream.active};e.settings.maxBitrate&&!he&&(r.maxBitrate=e.settings.maxBitrate),i.push(r)}let s=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:i});return this.setPreferredCodec(s,e.nativeTrack.kind),s}setMaxBitrate(e,t){return l(this,null,function*(){var i;yield(i=this.connection)==null?void 0:i.setMaxBitrate(e,t)})}setPreferredCodec(e,t){}replaceTrack(e,t){return l(this,null,function*(){yield this.replaceSenderTrack(e,t),e.stop(),this.replaceStreamTrack(e,t)})}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}replaceSenderTrack(e,t){return l(this,null,function*(){var i;let s=(i=this.connection)==null?void 0:i.getSenders().find(r=>r.track&&r.track.id===e.id);if(s===void 0){o.w(Ee,`No sender found for trackId=${e.id}`);return}yield s.replaceTrack(t)})}removeSender(e){let t=0;this.connection.getSenders().forEach(i=>{var s,r;if(((s=i.track)==null?void 0:s.id)===e.trackId||((r=i.track)==null?void 0:r.id)===e.getTrackIDBeingSent()){this.connection.removeTrack(i),t+=1;let n=this.tracks.indexOf(e);n!==-1?this.tracks.splice(n,1):o.e(Ee,`Cannot find ${e.trackId} in locally stored tracks`)}}),t!==1&&o.e(Ee,`Removed ${t} sender's, expected to remove 1`)}trackUpdate(e){var t;(t=this.connection)==null||t.trackUpdate(e)}},C=class{static connect(e,t,i=new Date,s=new Date,r){let n=this.eventNameFor("connect",e===void 0),a=e?b.ERROR:b.INFO,d=this.getPropertiesWithError(O(f({},t),{[this.KEY_REQUESTED_AT]:i?.getTime(),[this.KEY_RESPONDED_AT]:s?.getTime(),endpoint:r}),e);return new N({name:n,level:a,properties:d})}static disconnect(e,t){let i="disconnected",s=e?b.ERROR:b.INFO,r=this.getPropertiesWithError(t,e);return new N({name:i,level:s,properties:r})}static preview(e){var t=e,{error:i}=t,s=Je(t,["error"]);let r=this.eventNameFor("preview",i===void 0),n=i?b.ERROR:b.INFO,a=this.getPropertiesWithError(s,i);return new N({name:r,level:n,properties:a})}static join(e){var t=e,{error:i}=t,s=Je(t,["error"]);let r=this.eventNameFor("join",i===void 0),n=i?b.ERROR:b.INFO,a=this.getPropertiesWithError(O(f({},s),{is_preview_called:!!s.is_preview_called}),i);return new N({name:r,level:n,properties:a})}static publish({devices:e,settings:t,error:i}){let s=this.eventNameFor("publish",i===void 0),r=i?b.ERROR:b.INFO,n=this.getPropertiesWithError({devices:e,audio:t?.audio,video:t?.video},i);return new N({name:s,level:r,properties:n})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),i=b.ERROR,s=this.getErrorProperties(e);return new N({name:t,level:i,properties:s})}static leave(){return new N({name:"leave",level:b.INFO})}static autoplayError(){return new N({name:"autoplayError",level:b.ERROR})}static deviceChange({selection:e,type:t,devices:i,error:s}){let r=this.eventNameFor(s?"publish":`device.${t}`,s===void 0),n=s?b.ERROR:b.INFO,a=this.getPropertiesWithError({selection:e,devices:i},s);return new N({name:r,level:n,properties:a})}static performance(e){let t="perf.stats",i=b.INFO,s=e.toAnalyticsProperties();return new N({name:t,level:i,properties:s})}static rtcStats(e){let t="rtc.stats",i=b.INFO,s=e.toAnalyticsProperties();return new N({name:t,level:i,properties:s})}static degradationStats(e,t){let i="video.degradation.stats",s=b.INFO,r={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let n=new Date,a=n.valueOf()-e.degradedAt.valueOf();r=O(f({},r),{duration:a,restoredAt:n})}return new N({name:i,level:s,properties:r})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e),s=b.ERROR,r="audiopresence.failed";return new N({name:r,level:s,properties:i})}static previewNetworkQuality(e){return new N({name:"perf.networkquality.preview",level:e.error?b.ERROR:b.INFO,properties:e})}static HLSError(e,t=!0){return new N({name:`hls.${t?"start":"stop"}.failed`,level:b.ERROR,properties:this.getPropertiesWithError(e)})}static RTMPError(e,t=!0){return new N({name:`rtmp.${t?"start":"stop"}.failed`,level:b.ERROR,properties:this.getPropertiesWithError(e)})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=f(f({},i),e),e}static getErrorProperties(e){return e?e instanceof m?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};C.KEY_REQUESTED_AT="requested_at",C.KEY_RESPONDED_AT="responded_at";function Hi(e){return l(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia(e)}catch(t){throw ee(t,V.AV)}})}function Fs(e){return l(this,null,function*(){try{return yield navigator.mediaDevices.getDisplayMedia({video:e,audio:!1})}catch(t){throw ee(t,V.SCREEN)}})}function Gs(){return l(this,null,function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t={audioinput:[],audiooutput:[],videoinput:[]};return e.forEach(i=>t[i.kind].push(i)),t}catch(e){throw ee(e,V.AV)}})}var gt={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){this.getAudioContext().resume().catch(e=>{o.e("AudioContext",e)})}},P;(function(e){e.INIT="init_response_time",e.WEBSOCKET_CONNECT="ws_connect_time",e.ON_POLICY_CHANGE="on_policy_change_time",e.LOCAL_TRACKS="local_tracks_time",e.JOIN="join_time",e.PREVIEW="preview_time"})(P||(P={}));var Ki=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),o.d("[HMSPerformanceTiming]",e,(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration)}catch(i){o.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:i})}}getTimeTaken(e){var t;return(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration}getTimes(...e){return e.reduce((t,i)=>O(f({},t),{[i]:this.getTimeTaken(i)}),{})}cleanUp(){this.eventPerformanceMeasures={}}},pt={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},le,ke=class{constructor(e,t,i,s,r){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=s,this.analyticsTimer=r,this.TAG="[LocalTrackManager]"}getTracksToPublish(e){return l(this,null,function*(){let t=this.getTrackSettings(e);if(!t)return[];let i=!!t.audio,s=!!t.video,r=[],{videoTrack:n,audioTrack:a}=yield this.updateCurrentLocalTrackSettings(t),d=n?.stream||a?.stream,c=Boolean(n&&this.store.getTrackById(n.trackId)),h=Boolean(a&&this.store.getTrackById(a.trackId));if(c&&h)return[];let u={audio:i&&!a&&(e.isAudioMuted?"empty":!0),video:s&&!n&&(e.isVideoMuted?"empty":!0)};this.analyticsTimer.start(P.LOCAL_TRACKS);try{o.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:u}),r=yield this.getLocalTracks(u,t,d)}catch(v){r=yield this.retryGetLocalTracks(v,t,u,d)}return this.analyticsTimer.end(P.LOCAL_TRACKS),n&&s&&!c&&r.push(n),a&&i&&!h&&r.push(a),r})}getLocalTracks(){return l(this,arguments,function*(e={audio:!0,video:!0},t,i){try{let s=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(s,t,i)}catch(s){throw this.eventBus.analytics.publish(C.publish({devices:this.deviceManager.getDevices(),error:s,settings:t})),s}})}getNativeLocalTracks(){return l(this,arguments,function*(e={audio:!1,video:!1},t){let i=new Ne(e.video===!0?t.video:null,e.audio===!0?t.audio:null,t.simulcast),s=[];return(i.audio||i.video)&&s.push(...yield this.getAVTracks(i)),s.push(...this.getEmptyTracks(e)),s})}getLocalScreen(e,t){return l(this,null,function*(){let i={video:e.toConstraints()};if(t){let h=t.toConstraints();delete h.advanced,i.audio=O(f({},h),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}let s;try{s=yield navigator.mediaDevices.getDisplayMedia(i)}catch(h){throw ee(h,V.SCREEN)}let r=[],n=new fe(s),a=s.getVideoTracks()[0],d=new ye(n,a,"screen",this.eventBus,e);r.push(d);let c=s.getAudioTracks()[0];if(c){let h=new Be(n,c,"screen",this.eventBus,t);r.push(h)}return o.v(this.TAG,"getLocalScreen",r),r})}requestPermissions(){return l(this,null,function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach(e=>e.stop())}catch(e){o.e(this.TAG,e)}})}static getEmptyVideoTrack(e){var t,i,s;let r=((t=e?.getSettings())==null?void 0:t.width)||320,n=((i=e?.getSettings())==null?void 0:i.height)||240,a=10;le||(le=Object.assign(document.createElement("canvas"),{width:r,height:n}),(s=le.getContext("2d"))==null||s.fillRect(0,0,r,n));let d=le.captureStream(a).getVideoTracks()[0],c=setInterval(()=>{if(d.readyState==="ended"){clearInterval(c);return}let h=le.getContext("2d");if(h){let u=h.getImageData(0,0,1,1).data[0]===0?1:0;h.fillStyle=`rgb(${u}, 0, 0)`,h.fillRect(0,0,1,1)}},1e3/a);return d.onended=()=>{clearInterval(c)},d.enabled=!1,d}static getEmptyAudioTrack(){let e=gt.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let s=i.stream.getAudioTracks()[0];return s.enabled=!1,s}getAVTracks(e){return l(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:e.audio?e.audio.toConstraints():!1,video:e.video?e.video.toConstraints():!1});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!!(!this.deviceManager.hasWebcamPermission&&e.video),s=!!(!this.deviceManager.hasMicrophonePermission&&e.audio),r=this.getErrorType(i,s);throw ee(t,r)}})}getTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);if(!t&&!i)return null;let s=this.getScreenSettings();return new rt().video(i).audio(t).screen(s).build()}retryGetLocalTracks(e,t,i,s){return l(this,null,function*(){if(e instanceof m&&e.action===g.TRACK){this.observer.onFailure(e);let r=e.code===E.TracksErrors.OVER_CONSTRAINED,n=e.message.includes("audio"),a=e.message.includes("video");if(r){let d=new rt().video(new we).audio(new De).build();o.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,d,s)}catch(c){let h=c instanceof m?c.nativeError:c,u=c;if(h?.name==="OverconstrainedError"){let v=p.TracksErrors.GenericTrack(g.TRACK,"Overconstrained error after dropping all constraints");v.addNativeError(h),u=v}return yield this.retryGetLocalTracks(u,t,i,s)}}i.audio=n?"empty":i.audio,i.video=a?"empty":i.video,o.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,s)}catch(d){return o.w(this.TAG,"Fetch empty tacks failed",d),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(d),yield this.getLocalTracks(i,t,s)}}else return o.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[]})}getErrorType(e,t){return e&&t?V.AV:e?V.VIDEO:t?V.AUDIO:V.UNKNOWN}getEmptyTracks(e){let t=[];return e.audio==="empty"&&t.push(ke.getEmptyAudioTrack()),e.video==="empty"&&t.push(ke.getEmptyVideoTrack()),t}updateCurrentLocalTrackSettings(e){return l(this,null,function*(){let t=this.store.getLocalPeerTracks(),i=t.find(n=>n.type===w.VIDEO&&n.source==="regular"),s=t.find(n=>n.type===w.AUDIO&&n.source==="regular"),r=t.find(n=>n.type===w.VIDEO&&n.source==="screen");return e?.video&&(yield i?.setSettings(e.video)),e?.audio&&(yield s?.setSettings(e.audio)),e?.screen&&(yield r?.setSettings(e.screen)),{videoTrack:i,audioTrack:s}})}getAudioSettings(e){var t;let i=this.store.getPublishParams();if(!i||!((t=i.allowed)!=null&&t.includes("audio")))return null;let s=this.store.getLocalPeer(),r=s?.audioTrack,n=r?.settings.deviceId||e.audioInputDeviceId;return new se().codec(i.audio.codec).maxBitrate(i.audio.bitRate).deviceId(n||pt.audioInputDeviceId).build()}getVideoSettings(e){var t;let i=this.store.getPublishParams();if(!i||!((t=i.allowed)!=null&&t.includes("video")))return null;let s=this.store.getLocalPeer(),r=s?.videoTrack,n=r?.settings.deviceId||e.videoDeviceId,a=i.video,{width:d=a.width,height:c=a.height}=this.store.getSimulcastDimensions("regular")||{};return new q().codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(d).setHeight(c).deviceId(n||pt.videoDeviceId).build()}getScreenSettings(){var e;let t=this.store.getPublishParams();if(!t||!((e=t.allowed)!=null&&e.includes("screen")))return null;let i=t.screen,{width:s=i.width,height:r=i.height}=this.store.getSimulcastDimensions("screen")||{};return new q().maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(s).setHeight(r).build()}createHMSLocalTracks(e,t,i){let s=e.find(a=>a.kind==="video"),r=e.find(a=>a.kind==="audio");i?e.forEach(a=>i?.nativeStream.addTrack(a)):i=new fe(new MediaStream(e));let n=[];if(r&&t?.audio){let a=new Be(i,r,"regular",this.eventBus,t.audio);n.push(a)}if(s&&t?.video){let a=new ye(i,s,"regular",this.eventBus,t.video);n.push(a)}return n}};function mt(e,t){return function(i){return i in e&&e[i]!==t[i]}}var ye=class extends null{constructor(e,t,i,s,r=new q().build()){super(e,t,i),this.eventBus=s,this.buildNewSettings=n=>{let{width:a,height:d,codec:c,maxFramerate:h,maxBitrate:u,deviceId:v,advanced:T}=f(f({},this.settings),n);return new we(a,d,c,h,v,T,u)},this.handleSettingsChange=n=>l(this,null,function*(){let a=this.stream,d=mt(n,this.settings);d("maxBitrate")&&n.maxBitrate&&(yield a.setMaxBitrate(n.maxBitrate,this)),(d("width")||d("height")||d("advanced"))&&(yield this.nativeTrack.applyConstraints(n.toConstraints()))}),this.handleDeviceChange=(n,a=!1)=>l(this,null,function*(){if(mt(n,this.settings)("deviceId")&&this.source==="regular"){if(this.enabled){let d=yield this.replaceTrackWith(n);yield this.replaceSender(d,this.enabled),this.nativeTrack=d}a||Y.updateSelection("videoInput",{deviceId:n.deviceId,groupId:this.nativeTrack.getSettings().groupId})}}),e.tracks.push(this),this.settings=r,r.deviceId==="default"&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Wi(this,s),this.setFirstTrackId(this.trackId)}setEnabled(e){var t=i=>super[i];return l(this,null,function*(){if(e!==this.enabled){if(this.source==="regular"){let i;e?i=yield this.replaceTrackWith(this.settings):i=yield this.replaceTrackWithBlank(),yield this.replaceSender(i,e),this.nativeTrack=i,e&&(yield this.pluginsManager.waitForRestart(),this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId}))}yield t("setEnabled").call(this,e),this.eventBus.localVideoEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this)}})}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return l(this,null,function*(){let i=this.buildNewSettings(e);if(yield this.handleDeviceChange(i,t),!this.enabled){this.settings=i;return}yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,t){return l(this,null,function*(){return this.pluginsManager.addPlugin(e,t)})}removePlugin(e){return l(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){var e=t=>super[t];return l(this,null,function*(){var t;e("cleanup").call(this),yield this.pluginsManager.cleanup(),(t=this.processedTrack)==null||t.stop()})}setProcessedTrack(e){return l(this,null,function*(){if(!this.nativeTrack.enabled){this.processedTrack=e;return}if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled?this.processedTrack||this.nativeTrack:this.nativeTrack}replaceTrackWith(e){return l(this,null,function*(){let t=this.nativeTrack;t?.stop();let i=yield lt(e);return this.settings.deviceId==="default"&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),i})}replaceTrackWithBlank(){return l(this,null,function*(){let e=this.nativeTrack;return e?.stop(),ke.getEmptyVideoTrack(e)})}replaceSender(e,t){return l(this,null,function*(){let i=this.stream;t?yield i.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield i.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield i.replaceStreamTrack(this.nativeTrack,e)})}},ji=class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.tracksToProcess=new Map,this.handleTrackAdd=s=>{o.d(this.TAG,"ONTRACKADD",`${s}`),this.store.addTrack(s),this.tracksToProcess.set(s.trackId,s),this.processPendingTracks()},this.handleTrackRemove=s=>{var r;o.d(this.TAG,"ONTRACKREMOVE",`${s}`);let n=this.store.getTrackState(s.trackId);if(!n)return;s.type===w.AUDIO&&this.eventBus.audioTrackRemoved.publish(s);let a=this.store.getPeerById(n.peerId);!a||(this.removePeerTracks(a,s),this.store.removeTrack(s.trackId),(r=this.listener)==null||r.onTrackUpdate(D.TRACK_REMOVED,s,a))},this.handleTrackLayerUpdate=s=>{var r,n;for(let a in s.tracks){let d=s.tracks[a],c=this.store.getTrackById(a);if(!c)continue;let h=this.store.getPeerByTrackId(a);if(!!h&&c instanceof Re){let u=this.isTrackDegraded(d.expected_layer,d.current_layer);c.setLayerFromServer(d.current_layer,u),u?(r=this.listener)==null||r.onTrackUpdate(D.TRACK_DEGRADED,c,h):(n=this.listener)==null||n.onTrackUpdate(D.TRACK_RESTORED,c,h)}}},this.handleTrackUpdate=s=>{var r,n;let a=this.store.getPeerById(s.peer.peer_id);if(a)for(let d in s.tracks){let c=Object.assign({},(r=this.store.getTrackState(d))==null?void 0:r.trackInfo),h=s.tracks[d],u=this.store.getTrackById(d);if(this.store.setTrackState({peerId:s.peer.peer_id,trackInfo:f(f({},c),h)}),!u||this.tracksToProcess.has(d))this.processPendingTracks();else{u.setEnabled(!h.mute);let v=this.processTrackUpdate(u,c,h);v&&((n=this.listener)==null||n.onTrackUpdate(v,u,a))}}}}get TAG(){return`[${this.constructor.name}]`}isTrackDegraded(e,t){let i=s=>{switch(s){case G.HIGH:return 3;case G.MEDIUM:return 2;case G.LOW:return 1;case G.NONE:return 0}};return i(t)<i(e)}handleTrackMetadataAdd(e){o.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks)this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:e.tracks[t]});this.processPendingTracks()}processPendingTracks(){new Map(this.tracksToProcess).forEach(e=>{var t;let i=this.store.getTrackState(e.trackId);if(!i)return;let s=this.store.getPeerById(i.peerId);!s||(e.source=i.trackInfo.source,e.peerId=s.peerId,e.logIdentifier=s.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(s,e),this.addVideoTrack(s,e),e.type===w.AUDIO?this.eventBus.audioTrackAdded.publish({track:e,peer:s}):(t=this.listener)==null||t.onTrackUpdate(D.TRACK_ADDED,e,s),this.tracksToProcess.delete(e.trackId))})}removePeerTracks(e,t){var i,s;let r=e.auxiliaryTracks.indexOf(t);r>-1?e.auxiliaryTracks.splice(r,1):t.type===w.AUDIO&&((i=e.audioTrack)==null?void 0:i.trackId)===t.trackId?e.audioTrack=void 0:t.type===w.VIDEO&&((s=e.videoTrack)==null?void 0:s.trackId)===t.trackId&&(e.videoTrack=void 0)}addAudioTrack(e,t){t.type===w.AUDIO&&(!e.audioTrack&&t.source==="regular"?e.audioTrack=t:e.auxiliaryTracks.push(t))}addVideoTrack(e,t){if(t.type!==w.VIDEO)return;let i=t,s=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(s),!e.videoTrack&&t.source==="regular"?e.videoTrack=i:e.auxiliaryTracks.push(i)}processTrackUpdate(e,t,i){let s;return e.setEnabled(!i.mute),t.mute!==i.mute?(s=i.mute?D.TRACK_MUTED:D.TRACK_UNMUTED,e.type===w.AUDIO&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(s=D.TRACK_DESCRIPTION_CHANGED),s}},Ji=class{constructor(e){this.listener=e}handleQualityUpdate(e){var t;let i=e.peers.map(s=>({peerID:s.peer_id,downlinkQuality:s.downlink_score}));(t=this.listener)==null||t.onConnectionQualityUpdate(i)}},qi=class{constructor(e,t,i,s,r){this.store=e,this.listener=i,this.audioListener=s,this.connectionQualityListener=r,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=n=>{if(n===S.PEER_LIST)this.hasConsistentRoomStateArrived=!0;else if(n===S.ROOM_STATE)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=n=>{this.trackManager.handleTrackAdd(n)},this.handleTrackRemove=n=>{this.trackManager.handleTrackRemove(n)},this.updateLocalPeer=({name:n,metadata:a})=>{let d=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:d,name:n,data:a})},this.trackManager=new ji(this.store,t,this.listener),this.peerManager=new yi(this.store,this.trackManager,this.listener),this.peerListManager=new ki(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new fi(this.store,this.listener),this.policyChangeManager=new Si(this.store,t),this.requestManager=new Ai(this.store,this.listener),this.activeSpeakerManager=new pi(this.store,this.listener,this.audioListener),this.connectionQualityManager=new Ji(this.connectionQualityListener),this.roomUpdateManager=new Ii(this.store,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var i,s;let r=e.method,n=e.params;[S.ACTIVE_SPEAKERS,S.SFU_STATS,S.CONNECTION_QUALITY].includes(r)||o.d(this.TAG,`Received notification - ${r}`,{notification:n}),r===S.SFU_STATS&&((i=window.HMS)==null?void 0:i.ON_SFU_STATS)&&typeof((s=window.HMS)==null?void 0:s.ON_SFU_STATS)=="function"&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(r)&&(this.roomUpdateManager.handleNotification(r,n),this.peerManager.handleNotification(r,n),this.requestManager.handleNotification(r,n),this.peerListManager.handleNotification(r,n,t),this.broadcastManager.handleNotification(r,n),this.handleIsolatedMethods(r,n))}handleIsolatedMethods(e,t){switch(e){case S.TRACK_METADATA_ADD:{this.trackManager.handleTrackMetadataAdd(t);break}case S.TRACK_UPDATE:{this.trackManager.handleTrackUpdate(t);break}case S.ON_SFU_TRACK_LAYER_UPDATE:{this.trackManager.handleTrackLayerUpdate(t);break}case S.ACTIVE_SPEAKERS:this.activeSpeakerManager.handleActiveSpeakers(t);break;case S.CONNECTION_QUALITY:this.connectionQualityManager.handleQualityUpdate(t);break;case S.POLICY_CHANGE:this.policyChangeManager.handlePolicyChange(t);break;default:break}}},Tt=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof ri?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}},I;(function(e){e.Disconnected="Disconnected",e.Connecting="Connecting",e.Joined="Joined",e.Preview="Preview",e.Failed="Failed",e.Reconnecting="Reconnecting",e.Leaving="Leaving"})(I||(I={}));var Yi=class{constructor(e,t,i="",s="",r="https://prod-init.100ms.live/init",n=!1){this.authToken=e,this.peerId=t,this.peerName=i,this.data=s,this.endpoint=r,this.autoSubscribeVideo=n}},de;(function(e){e.FLAG_SERVER_SUB_DEGRADATION="subscribeDegradation",e.FLAG_SERVER_SIMULCAST="simulcast",e.FLAG_NON_WEBRTC_DISABLE_OFFER="nonWebRTCDisableOffer"})(de||(de={}));var R;(function(e){e[e.ConnectFailed=0]="ConnectFailed",e[e.SignalDisconnect=1]="SignalDisconnect",e[e.JoinWSMessageFailed=2]="JoinWSMessageFailed",e[e.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",e[e.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed"})(R||(R={}));var Qi={[0]:[],[1]:[],[2]:[1],[3]:[1],[4]:[1]},zi=class{constructor(e){this.promise=new Promise((t,i)=>{this.resolve=t,this.reject=i,e(t,i)})}},Q="[RetryScheduler]",Zi=class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return l(this,arguments,function*({category:t,error:i,task:s,originalState:r,maxFailedRetries:n=be,changeState:a=!0}){yield this.scheduleTask({category:t,error:i,changeState:a,task:s,originalState:r,maxFailedRetries:n})})}reset(){this.retryTaskIds.forEach(e=>clearTimeout(e)),this.retryTaskIds=[],this.inProgress.clear()}scheduleTask(e){return l(this,arguments,function*({category:t,error:i,changeState:s,task:r,originalState:n,maxFailedRetries:a=be,failedRetryCount:d=0}){if(o.d(Q,"schedule: ",{category:R[t],error:i}),d===0){let T=this.inProgress.get(t);if(T){o.d(Q,`schedule: Already a task for ${R[t]} scheduled, waiting for its completion`),yield T.promise;return}let _=new zi((W,z)=>{});this.inProgress.set(t,_),this.sendEvent(i,t)}let c=!1,h=Qi[t];for(let T in h){let _=h[parseInt(T)];try{let W=this.inProgress.get(_);W&&(o.d(Q,`schedule: Suspending retry task of ${R[t]}, waiting for ${R[_]} to recover`),yield W.promise,o.d(Q,`schedule: Resuming retry task ${R[t]} as it's dependency ${R[_]} is recovered`))}catch{o.d(Q,`schedule: Stopping retry task of ${R[t]} as it's dependency ${R[_]} failed to recover`),c=!0;break}}if(d>=a||c){if(i.description+=`. [${R[t]}] Could not recover after ${d} tries`,c&&(i.description+=` Could not recover all of it's required dependencies - [${h.map(T=>R[T]).toString()}]`),i.isTerminal=!0,this.inProgress.delete(t),this.sendEvent(i,t),this.reset(),s)this.onStateChange(I.Failed,i);else throw i;return}s&&this.onStateChange(I.Reconnecting,i);let u=this.getDelayForRetryCount(t,d);o.i(Q,`schedule: [${R[t]}] [failedRetryCount=${d}] Scheduling retry task in ${u}ms`);let v;try{v=yield this.setTimeoutPromise(r,u)}catch(T){v=!1,o.w(Q,`[${R[t]}] Un-caught exception ${T.name} in retry-task, initiating retry`,T)}if(v){let T=this.inProgress.get(t);this.inProgress.delete(t),T?.resolve(d),s&&this.inProgress.size===0&&this.onStateChange(n),o.i(Q,`schedule: [${R[t]}] [failedRetryCount=${d}] Recovered \u267B\uFE0F`)}else yield this.scheduleTask({category:t,error:i,changeState:s,task:r,originalState:n,maxFailedRetries:a,failedRetryCount:d+1})})}getBaseDelayForTask(e,t){return e===R.JoinWSMessageFailed?2:Math.pow(2,t)}getDelayForRetryCount(e,t){let i=this.getBaseDelayForTask(e,t),s=e===R.JoinWSMessageFailed?Math.random()*2:Math.random();return Math.round(Math.min(i+s,Kt)*1e3)}setTimeoutPromise(e,t){return l(this,null,function*(){return new Promise((i,s)=>{let r=window.setTimeout(()=>l(this,null,function*(){try{let n=yield e();n&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(r),1),i(n)}catch(n){s(n)}}),t);this.retryTaskIds.push(r)})})}},Xi=class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new ue("client-events"),this.isConnected=!0,this.env=null}setEnv(e){this.env=e,this.flushFailedEvents()}sendEvent(e){if(!this.env){this.addEventToStorage(e);return}let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id},i=this.env===F.PROD?Zt:Xt;fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then(s=>{if(s.status===401){this.removeFromStorage(e);return}if(s.status!==200)throw Error(s.statusText);this.removeFromStorage(e)}).catch(s=>{o.v(this.TAG,"Failed to send event",s,e),this.addEventToStorage(e)})}flushFailedEvents(){let e=this.failedEvents.get();e?.forEach(t=>this.sendEvent(t))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find(i=>i.timestamp===e.timestamp)||(t.length===ei&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex(s=>s.timestamp===e.timestamp);i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},Se=new Xi,Bs=class{constructor(){this.TAG="AnalyticsTransport"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(t){o.w(this.TAG,"sendEvent failed",t)}}flushFailedEvents(e){var t;try{for(o.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&(((t=i.metadata)==null?void 0:t.peer.peer_id)===e||!i.metadata.peer.peer_id?this.sendSingleEvent(i):Se.sendEvent(i))}}catch(i){o.w(this.TAG,"flushFailedEvents failed",i)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),o.d(this.TAG,"Sent event",e.name,e)}catch(t){throw o.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}},es=class extends null{constructor(){super(tt),this.localStorage=new ue("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;(e=this.localStorage.get())==null||e.forEach(t=>{let i=new N(t);super.enqueue(i)})}},ts=class extends null{constructor(e){super(),this.transportProvider=e,this.failedEvents=new es}},is=class{constructor(e,t){this.store=e,this.eventBus=t,this.TAG="[TrackDegradationController]",this.MAX_RECOVER_GRACE_PERIOD=120,this.recoverAttemptCount=0,this.packetsLost=0;let i=this.store.getSubscribeDegradationParams();this.PACKETS_LOST_THRESHOLD=i.packetLossThreshold,this.MIN_DEGRADE_GRACE_PERIOD=i.degradeGracePeriodSeconds,this.MIN_RECOVER_GRACE_PERIOD=i.recoverGracePeriodSeconds,this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}get isAttemptingRecover(){return Boolean(this.recoveringTrack)}handleRtcStatsChange(e){let t=e>this.packetsLost+this.PACKETS_LOST_THRESHOLD;this.packetsLost=e,t?this.degrade():this.recover()}degrade(){if(this.degradeGracePeriod>0){this.degradeGracePeriod--;return}if(this.isAttemptingRecover)return this.cancelRecovery();o.d(this.TAG,"Packet loss increased, Degrading",{packetsLost:this.packetsLost}),this.degradeActiveTracksByHalf(),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}recover(){if(this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod>0){this.recoverGracePeriod--;return}this.recoveringTrack=this.getActiveTracks(!0).find(e=>e.degraded),this.recoveringTrack&&(o.d(this.TAG,"Packet lost stable, recovering track",this.recoveringTrack),this.recoveringTrack.setDegradedFromSdk(!1),this.eventBus.trackRestored.publish(this.recoveringTrack),this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD)}cleanUp(){this.eventBus.trackDegraded.removeAllListeners(),this.eventBus.trackRestored.removeAllListeners()}degradeActiveTracksByHalf(){let e=this.getActiveTracks(!1);if(!e.length)return;o.d(this.TAG,{activeTracks:[...e]});let t=Math.ceil(e.length/2);for(;t--;){let i=e.pop();i.setDegradedFromSdk(!0),this.eventBus.trackDegraded.publish(i)}}getActiveTracks(e){return this.store.getRemoteVideoTracks().filter(t=>t.hasSinks()&&(!t.degraded||e)).sort((t,i)=>{let s=this.store.getComparator().getTrackComparators();return-1*(s.screenShare(t,i)||s.rolePriority(t,i)||s.peerAudioLevel(t,i)||this.store.getComparator().stringComparator(t.trackId,i.trackId))}).slice(0)}cancelRecovery(){this.recoveringTrack&&(this.recoveringTrack.setDegradedFromSdk(!0),this.eventBus.trackDegraded.publish(this.recoveringTrack)),this.recoveringTrack=void 0,this.recoverAttemptCount++,this.recoverGracePeriod=this.getDelayForRecoverCount(this.recoverAttemptCount),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,o.d(this.TAG,"Recover Attempt Failed",{count:this.recoverAttemptCount,delay:this.recoverGracePeriod})}getDelayForRecoverCount(e){let t=this.MIN_RECOVER_GRACE_PERIOD+this.MIN_RECOVER_GRACE_PERIOD*e;return Math.min(t,this.MAX_RECOVER_GRACE_PERIOD)}},ss=e=>{let t=e.stream instanceof fe,i=t?"publish":"subscribe",s=t?e.getTrackBeingSent():e.nativeTrack;return{peerConnectionType:i,nativeTrack:s}},rs=(e,t,i,s)=>l(void 0,null,function*(){var r;let{peerConnectionType:n,nativeTrack:a}=ss(t),d;try{d=yield(r=e[n])==null?void 0:r.call(e,a)}catch(v){o.w("[HMSWebrtcStats]","Error in getting track stats",t,a,v)}let c=ns(d),h=ft(n==="publish"?"bytesSent":"bytesReceived",c,s),u=Ve("packetsLost",c,s);return c?.remote&&Object.assign(c.remote,{packetsLostRate:Ve("packetsLost",c.remote,s?.remote)}),c&&Object.assign(c,{bitrate:h,packetsLostRate:u,peerId:t.peerId,peerName:i,codec:c.codec})}),ns=e=>{let t,i,s={};e?.forEach(a=>{switch(a.type){case"inbound-rtp":t=a;break;case"outbound-rtp":t=a;break;case"remote-inbound-rtp":i=a;break;case"codec":s[a.id]=a.mimeType;break;default:break}});let r=t?.codecId?s[t.codecId]:void 0,n;return r&&(n=r.substring(r.indexOf("/")+1)),t&&Object.assign(t,{remote:i,codec:n})},Et=(e,t,i)=>{let s=as(t),r=ft(e==="publish"?"bytesSent":"bytesReceived",s,i&&i[e]);return s&&Object.assign(s,{bitrate:r})},as=e=>{let t;return e.forEach(i=>{i.type==="transport"&&(t=e.get(i.selectedCandidatePairId))}),t||e.forEach(i=>{i.type==="candidate-pair"&&i.selected&&(t=i)}),t},os=e=>{let t={packetsLost:0,jitter:0};return e?.forEach(i=>{i.packetsLost&&(t.packetsLost+=i.packetsLost),i.jitter>t.jitter&&(t.jitter=i.jitter)}),t},ls=(e,t)=>Array.from(new Set(e.concat(t))),ft=(e,t,i)=>Ve(e,t,i)*8,Ve=(e,t,i)=>{let s=t&&t[e],r=i?i[e]:null;return[t,i,X(s),X(r)].every(n=>!!n)?kt(s,r,t?.timestamp,i?.timestamp)*1e3:0},kt=(e,t,i,s)=>X(e)&&X(t)&&i&&s?(e-t)/(i-s):0,ds=class{constructor(e,t){this.getStats=e,this.store=t,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.trackStats={};var i;this.localPeerID=(i=this.store.getLocalPeer())==null?void 0:i.peerId}getLocalPeerStats(){return this.peerStats[this.localPeerID]}getTrackStats(e){return this.trackStats[e]}updateStats(){return l(this,null,function*(){yield this.updateLocalPeerStats(),yield this.updateTrackStats()})}updateLocalPeerStats(){return l(this,null,function*(){var e,t,i,s,r,n;let a=this.getLocalPeerStats(),d;try{d=yield(t=(e=this.getStats).publish)==null?void 0:t.call(e)}catch(z){o.w(this.TAG,"Error in getting publish stats",z)}let c=d&&Et("publish",d,a),h;try{h=yield(s=(i=this.getStats).subscribe)==null?void 0:s.call(i)}catch(z){o.w(this.TAG,"Error in getting subscribe stats",z)}let u=h&&Et("subscribe",h,a),{packetsLost:v,jitter:T}=os(h),_=kt(v,(r=a?.subscribe)==null?void 0:r.packetsLost,u?.timestamp,(n=a?.subscribe)==null?void 0:n.timestamp),W=u&&Object.assign(u,{packetsLostRate:_,jitter:T,packetsLost:v});this.peerStats[this.localPeerID]={publish:c,subscribe:W}})}updateTrackStats(){return l(this,null,function*(){var e;let t=this.store.getTracksMap(),i=ls(Object.keys(this.trackStats),Object.keys(t));for(let s of i){let r=t[s];if(r){let n=r.peerId&&((e=this.store.getPeerById(r.peerId))==null?void 0:e.name),a=this.getTrackStats(r.trackId),d=yield rs(this.getStats,r,n,a);d&&(this.trackStats[s]=d)}else delete this.trackStats[s]}})}},cs=class{constructor(e,t,i,s){this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=s,this.TAG="[HMSWebrtcInternals]",this.interval=Qt,this.isMonitored=!1,this.handleStatsUpdate=()=>l(this,null,function*(){var r;yield(r=this.hmsStats)==null?void 0:r.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)})}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,s;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new ds({publish:(i=this.publishConnection)==null?void 0:i.getStats.bind(this.publishConnection),subscribe:(s=this.subscribeConnection)==null?void 0:s.getStats.bind(this.subscribeConnection)},this.store)}start(){return l(this,null,function*(){if(this.isMonitored){o.d(this.TAG,"Already started");return}this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then(()=>o.d(this.TAG,"Stopping Webrtc Stats Monitor")).catch(e=>o.e(this.TAG,e.message))})}stop(){this.isMonitored=!1}startLoop(){return l(this,null,function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield J(this.interval)})}cleanUp(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}},us=()=>{if(!ve||typeof navigator.connection>"u")return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}},k="[HMSTransport]:",hs=class{constructor(e,t,i,s,r,n,a){this.observer=e,this.deviceManager=t,this.store=i,this.localTrackManager=s,this.eventBus=r,this.analyticsEventsService=n,this.analyticsTimer=a,this.state=I.Disconnected,this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.joinRetryCount=0,this.callbacks=new Map,this.signalObserver={onOffer:u=>l(this,null,function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(u),o.d(k,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let T of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(T);this.subscribeConnection.candidates.length=0;let v=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(v),this.signal.answer(v),o.d(k,"[role=SUBSCRIBE] onOffer renegotiation DONE \u2705")}catch(v){o.d(k,"[role=SUBSCRIBE] onOffer renegotiation FAILED \u274C"),this.state=I.Failed;let T;throw v instanceof m?T=v:T=p.GenericErrors.Unknown(g.PUBLISH,v.message),this.eventBus.analytics.publish(C.subscribeFail(T)),T}}),onTrickle:u=>l(this,null,function*(){let v=u.target===x.Publish?this.publishConnection:this.subscribeConnection;v?.remoteDescription?yield v.addIceCandidate(u.candidate):v?.candidates.push(u.candidate)}),onNotification:u=>this.observer.onNotification(u),onServerError:u=>l(this,null,function*(){yield this.observer.onStateChange(I.Failed,u)}),onFailure:u=>{this.joinParameters&&this.retryScheduler.schedule({category:R.SignalDisconnect,error:u,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:u=>l(this,null,function*(){o.d(k,"socket offline",I[this.state]);try{this.state!==I.Leaving&&this.joinParameters&&this.retryScheduler.schedule({category:R.SignalDisconnect,error:p.WebSocketConnectionErrors.WebSocketConnectionLost(g.RECONNECT_SIGNAL,u),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(v){console.error(v)}}),onOnline:()=>{var u;o.d(k,"socket online",I[this.state]),this.analyticsSignalTransport.flushFailedEvents((u=this.store.getLocalPeer())==null?void 0:u.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new gi(this.signalObserver),this.analyticsSignalTransport=new ts(this.signal),this.publishConnectionObserver={onRenegotiationNeeded:()=>l(this,null,function*(){yield this.performPublishRenegotiation()}),onIceConnectionChange:u=>l(this,null,function*(){(u==="disconnected"?o.w.bind(o):o.d.bind(o))(k,`Publish ice connection state change: ${u}`)}),onConnectionStateChange:u=>l(this,null,function*(){var v;(u==="disconnected"?o.w.bind(o):o.d.bind(o))(k,`Publish connection state change: ${u}`),u==="connected"&&((v=this.publishConnection)==null||v.logSelectedIceCandidatePairs()),u==="failed"&&(yield this.handleIceConnectionFailure(x.Publish))})},this.subscribeConnectionObserver={onApiChannelMessage:u=>{this.observer.onNotification(JSON.parse(u))},onTrackAdd:u=>{o.d(k,"[Subscribe] onTrackAdd",ge(u.nativeTrack)),this.observer.onTrackAdd(u)},onTrackRemove:u=>{o.d(k,"[Subscribe] onTrackRemove",ge(u.nativeTrack)),this.observer.onTrackRemove(u)},onIceConnectionChange:u=>l(this,null,function*(){if((u==="disconnected"?o.w.bind(o):o.d.bind(o))(k,`Subscribe ice connection state change: ${u}`),u==="connected"){let v=this.callbacks.get(ae);this.callbacks.delete(ae),v&&v.promise.resolve(!0)}}),onConnectionStateChange:u=>l(this,null,function*(){var v;if((u==="disconnected"?o.w.bind(o):o.d.bind(o))(k,`Subscribe connection state change: ${u}`),u==="failed"&&(yield this.handleIceConnectionFailure(x.Subscribe)),u==="connected"){(v=this.subscribeConnection)==null||v.logSelectedIceCandidatePairs();let T=this.callbacks.get(ae);this.callbacks.delete(ae),T&&T.promise.resolve(!0)}})},this.handleLocalRoleUpdate=u=>l(this,[u],function*({oldRole:v,newRole:T}){!(!this.doesRoleNeedWebRTC(v)&&this.doesRoleNeedWebRTC(T))||(o.i(k,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation \u23F3"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())}),this.retryPublishIceFailedTask=()=>l(this,null,function*(){if(this.publishConnection&&(this.publishConnection.iceConnectionState!=="connected"||this.publishConnection.connectionState!=="connected")){let u=new Promise((v,T)=>{this.callbacks.set(ne,{promise:{resolve:v,reject:T},action:g.RESTART_ICE,extra:{}})});yield this.performPublishRenegotiation({iceRestart:!0}),yield u}return!0}),this.retrySubscribeIceFailedTask=()=>l(this,null,function*(){if(this.subscribeConnection&&(this.subscribeConnection.iceConnectionState!=="connected"||this.subscribeConnection.connectionState!=="connected")){let u=new Promise((T,_)=>{this.callbacks.set(ae,{promise:{resolve:T,reject:_},action:g.RESTART_ICE,extra:{}})}),v=new Promise(T=>{setTimeout(T,Yt,!1)});return Promise.race([u,v])}return!0}),this.retrySignalDisconnectTask=()=>l(this,null,function*(){if(o.d(k,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),!this.signal.isConnected)try{yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId)}catch{}let u=this.store.getRoom().joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),u});var d,c;this.webrtcInternals=new cs(this.store,this.eventBus,(d=this.publishConnection)==null?void 0:d.nativeConnection,(c=this.subscribeConnection)==null?void 0:c.nativeConnection);let h=(u,v)=>l(this,null,function*(){u!==this.state&&(this.state=u,yield this.observer.onStateChange(this.state,v))});this.retryScheduler=new Zi(h,this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe(u=>{var v,T;let _=((T=(v=u.getLocalPeerStats())==null?void 0:v.subscribe)==null?void 0:T.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,_)})}getLocalScreen(e,t){return l(this,null,function*(){try{return yield this.localTrackManager.getLocalScreen(e,t)}catch(i){throw this.eventBus.analytics.publish(C.publish({error:i,devices:this.deviceManager.getDevices(),settings:new Ne(e,t,!1)})),i}})}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let i=(t=this.initConfig)==null?void 0:t.config;return(i?.enabledFlags||[]).includes(e)}preview(e,t,i,s,r=!1){return l(this,null,function*(){let n=yield this.connect(e,t,i,s,r);return this.state=I.Preview,this.observer.onStateChange(this.state),n})}join(e,t,i,s,r=!1){return l(this,null,function*(){o.d(k,"join: started \u23F0");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,s,t,i,r)),this.validateNotDisconnected("connect");let n=this.isFlagEnabled(de.FLAG_SERVER_SUB_DEGRADATION);this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,r,n),yield this.initRtcStatsMonitor(),o.d(k,"\u2705 join: Negotiated over PUBLISH connection"))}catch(n){o.e(k,`join: failed \u274C [token=${e}]`,n),this.state=I.Failed;let a=n;throw a.isTerminal=a.isTerminal||a.code===500,yield this.observer.onStateChange(this.state,a),a}o.i(k,"\u2705 join: successful"),this.state=I.Joined,this.observer.onStateChange(this.state)})}connect(e,t,i,s,r=!1){return l(this,null,function*(){this.setTransportStateForConnect(),this.joinParameters=new Yi(e,i,s.name,s.metaData,t,r);try{return yield this.internalConnect(e,t,i)}catch(n){if(n instanceof m&&([E.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,E.WebSocketConnectionErrors.FAILED_TO_CONNECT,E.WebSocketConnectionErrors.ABNORMAL_CLOSE,E.InitAPIErrors.ENDPOINT_UNREACHABLE].includes(n.code)||n.code.toString().startsWith("5")||n.code.toString().startsWith("429"))){let a=()=>l(this,null,function*(){return yield this.internalConnect(e,t,i),Boolean(this.initConfig&&this.initConfig.endpoint)});yield this.retryScheduler.schedule({category:R.ConnectFailed,error:n,task:a,originalState:this.state,maxFailedRetries:be,changeState:!1})}else throw n}})}leave(e){return l(this,null,function*(){var t,i,s,r;this.retryScheduler.reset(),this.joinParameters=void 0,o.d(k,"leaving in transport");try{if(this.state=I.Leaving,(t=this.webrtcInternals)==null||t.cleanUp(),(i=this.trackDegradationController)==null||i.cleanUp(),yield(s=this.publishConnection)==null?void 0:s.close(),yield(r=this.subscribeConnection)==null?void 0:r.close(),e)try{this.signal.leave(),o.d(k,"signal leave done")}catch(n){o.w(k,"failed to send leave on websocket to server",n)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(n){this.eventBus.analytics.publish(C.disconnect(n)),o.e(k,"leave: FAILED \u274C",n)}finally{this.state=I.Disconnected,this.observer.onStateChange(this.state)}})}publish(e){return l(this,null,function*(){for(let t of e)try{yield this.publishTrack(t)}catch(i){this.eventBus.analytics.publish(C.publish({devices:this.deviceManager.getDevices(),error:i}))}})}unpublish(e){return l(this,null,function*(){for(let t of e)yield this.unpublishTrack(t)})}sendMessage(e){return l(this,null,function*(){return yield this.signal.broadcast(e)})}trackUpdate(e){let t=Array.from(this.trackStates.values()).find(i=>e.type===i.type&&e.source===i.source);if(t){let i=new Tt(O(f({},t),{mute:!e.enabled}));this.trackStates.set(t.track_id,i),o.d(k,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[t.track_id,i]]))}}changeRole(e,t,i=!1){return l(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e.peerId,role:t,force:i})})}acceptRoleChange(e){return l(this,null,function*(){yield this.signal.acceptRoleChangeRequest({role:e.role.name,token:e.token})})}endRoom(e,t){return l(this,null,function*(){yield this.signal.endRoom(e,t)})}removePeer(e,t){return l(this,null,function*(){yield this.signal.removePeer({requested_for:e,reason:t})})}startRTMPOrRecording(e){return l(this,null,function*(){var t;let i={meeting_url:e.meetingURL,record:e.record};(t=e.rtmpURLs)!=null&&t.length&&(i.rtmp_urls=e.rtmpURLs),e.resolution&&(i.resolution=e.resolution),yield this.signal.startRTMPOrRecording(i)})}stopRTMPOrRecording(){return l(this,null,function*(){yield this.signal.stopRTMPAndRecording()})}startHLSStreaming(e){return l(this,null,function*(){let t={};e&&e.variants&&e.variants.length>0&&(t.variants=e.variants.map(i=>{let s={meeting_url:i.meetingURL};return i.metadata&&(s.metadata=i.metadata),s})),e?.recording&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)})}stopHLSStreaming(e){return l(this,null,function*(){var t;if(e){let i={variants:(t=e?.variants)==null?void 0:t.map(s=>{let r={meeting_url:s.meetingURL};return s.metadata&&(r.metadata=s.metadata),r})};yield this.signal.stopHLSStreaming(i)}yield this.signal.stopHLSStreaming()})}sendHLSTimedMetadata(e){return l(this,null,function*(){if(e.length>0){let t={metadata_objs:e};yield this.signal.sendHLSTimedMetadata(t)}})}changeName(e){return l(this,null,function*(){yield this.signal.updatePeer({name:e})})}changeMetadata(e){return l(this,null,function*(){yield this.signal.updatePeer({data:e})})}getSessionMetadata(){return this.signal.getSessionMetadata()}setSessionMetadata(e){return l(this,null,function*(){yield this.signal.setSessionMetadata({data:e})})}changeTrackState(e){return l(this,null,function*(){yield this.signal.requestTrackStateChange(e)})}changeMultiTrackState(e){return l(this,null,function*(){yield this.signal.requestMultiTrackStateChange(e)})}publishTrack(e){return l(this,null,function*(){e.publishedTrackId=e.getTrackIDBeingSent(),o.d(k,`\u23F3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new Tt(e));let t=new Promise((n,a)=>{this.callbacks.set(ne,{promise:{resolve:n,reject:a},action:g.PUBLISH,extra:{}})}),i=e.stream;i.setConnection(this.publishConnection);let s=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,s),o.time(`publish-${e.trackId}-${e.type}`),yield t,o.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e);let r=e.settings.maxBitrate;r&&(yield i.setMaxBitrate(r,e).then(()=>{o.d(k,`Setting maxBitrate for ${e.source} ${e.type} to ${r} kpbs`)}).catch(n=>o.w(k,"Failed setting maxBitrate",n))),o.d(k,`\u2705 publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)})}unpublishTrack(e){return l(this,null,function*(){if(o.d(k,`\u23F3 unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let i=Array.from(this.trackStates.values()).find(s=>e.type===s.type&&e.source===s.source);i&&this.trackStates.delete(i.track_id)}let t=new Promise((i,s)=>{this.callbacks.set(ne,{promise:{resolve:i,reject:s},action:g.UNPUBLISH,extra:{}})});e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e.trackId),o.d(k,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)})}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise(e=>{this.eventBus.policyChange.subscribeOnce(()=>e())})}createConnectionsAndNegotiateJoin(e,t=!1,i=!0){return l(this,null,function*(){let s=this.doesLocalPeerNeedWebRTC();s&&this.createPeerConnections(),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,serverSubDegrade:i,isWebRTC:s})})}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new ii(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver,this)),this.subscribeConnection||(this.subscribeConnection=new oi(this.signal,this.initConfig.rtcConfiguration,this.subscribeConnectionObserver)))}negotiateJoinWithRetry(e){return l(this,arguments,function*({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r,isWebRTC:n=!0}){try{yield this.negotiateJoin({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r,isWebRTC:n})}catch(a){o.e(k,"Join negotiation failed \u274C",a);let d=a instanceof m?a:p.WebsocketMethodErrors.ServerErrors(500,g.JOIN,`Websocket join error - ${a.message}`);if(parseInt(`${d.code/100}`)===5||d.code===429){this.joinRetryCount=0,d.isTerminal=!1;let c=()=>l(this,null,function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r,isWebRTC:n})});yield this.retryScheduler.schedule({category:R.JoinWSMessageFailed,error:d,task:c,originalState:I.Joined,maxFailedRetries:3,changeState:!1})}else throw a}})}negotiateJoin(e){return l(this,arguments,function*({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r,isWebRTC:n=!0}){return n?yield this.negotiateJoinWebRTC({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r}):yield this.negotiateJoinNonWebRTC({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r})})}negotiateJoinWebRTC(e){return l(this,arguments,function*({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r}){if(o.d(k,"\u23F3 join: Negotiating over PUBLISH connection"),!this.publishConnection)return o.e(k,"Publish peer connection not found, cannot negotiate"),!1;let n=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(n);let a=yield this.signal.join(t,i,!s,r,n);yield this.publishConnection.setRemoteDescription(a);for(let d of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(d);return this.publishConnection.initAfterJoin(),!!a})}negotiateJoinNonWebRTC(e){return l(this,arguments,function*({name:t,data:i,autoSubscribeVideo:s,serverSubDegrade:r}){return o.d(k,"\u23F3 join: Negotiating Non-WebRTC"),!!(yield this.signal.join(t,i,!s,r))})}negotiateOnFirstPublish(){return l(this,null,function*(){if(o.d(k,"\u23F3 Negotiating offer over PUBLISH connection"),!this.publishConnection)return o.e(k,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t})}performPublishRenegotiation(e){return l(this,null,function*(){o.d(k,"\u23F3 [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(ne);if(t){if(!this.publishConnection){o.e(k,"Publish peer connection not found, cannot renegotiate");return}try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),o.time("renegotiation-offer-exchange");let s=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(ne),o.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(s),t.promise.resolve(!0),o.d(k,"[role=PUBLISH] onRenegotiationNeeded DONE \u2705")}catch(i){let s;i instanceof m?s=i:s=p.GenericErrors.Unknown(g.PUBLISH,i.message),t.promise.reject(s),o.d(k,"[role=PUBLISH] onRenegotiationNeeded FAILED \u274C")}}})}handleIceConnectionFailure(e){return l(this,null,function*(){e===x.Publish?this.retryScheduler.schedule({category:R.PublishIceConnectionFailed,error:p.WebrtcErrors.ICEFailure(g.PUBLISH),task:this.retryPublishIceFailedTask,originalState:I.Joined}):this.retryScheduler.schedule({category:R.SubscribeIceConnectionFailed,error:p.WebrtcErrors.ICEFailure(g.SUBSCRIBE),task:this.retrySubscribeIceFailedTask,originalState:I.Joined,maxFailedRetries:1})})}internalConnect(e,t,i){return l(this,null,function*(){o.d(k,"connect: started \u23F0");let s=new Date;try{return this.analyticsTimer.start(P.INIT),this.initConfig=yield li.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t}),this.analyticsTimer.end(P.INIT),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),o.d(k,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(r){throw this.state!==I.Reconnecting&&this.eventBus.analytics.publish(C.connect(r,this.getAdditionalAnalyticsProperties(),s,new Date,t)),o.d(k,"\u274C internal connect: failed",r),r}})}validateNotDisconnected(e){if(this.state===I.Disconnected)throw o.w(k,"aborting join as transport state is disconnected"),p.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return l(this,null,function*(){if(!this.initConfig)throw p.InitAPIErrors.InitConfigNotAvailable(g.INIT,"Init Config not found");o.d(k,"\u23F3 internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),this.endpoint=i.toString(),this.analyticsTimer.start(P.WEBSOCKET_CONNECT),yield this.signal.open(this.endpoint),this.analyticsTimer.end(P.WEBSOCKET_CONNECT),this.analyticsTimer.start(P.ON_POLICY_CHANGE),o.d(k,"\u2705 internal connect: connected to ws endpoint")})}initRtcStatsMonitor(){return l(this,null,function*(){var e,t,i,s;(i=this.webrtcInternals)==null||i.setPeerConnections({publish:(e=this.publishConnection)==null?void 0:e.nativeConnection,subscribe:(t=this.subscribeConnection)==null?void 0:t.nativeConnection}),this.store.getSubscribeDegradationParams()&&(this.isFlagEnabled(de.FLAG_SERVER_SUB_DEGRADATION)||(yield(s=this.webrtcInternals)==null?void 0:s.start(),this.trackDegradationController=new is(this.store,this.eventBus),this.eventBus.statsUpdate.subscribe(r=>{var n,a,d;(d=this.trackDegradationController)==null||d.handleRtcStatsChange(((a=(n=r.getLocalPeerStats())==null?void 0:n.subscribe)==null?void 0:a.packetsLost)||0)})),this.eventBus.trackDegraded.subscribe(r=>{this.eventBus.analytics.publish(C.degradationStats(r,!0)),this.observer.onTrackDegrade(r)}),this.eventBus.trackRestored.subscribe(r=>{this.eventBus.analytics.publish(C.degradationStats(r,!1)),this.observer.onTrackRestore(r)}))})}doesRoleNeedWebRTC(e){var t,i;if(!this.isFlagEnabled(de.FLAG_NON_WEBRTC_DISABLE_OFFER))return!0;let s=Boolean(e.publishParams.allowed&&((t=e.publishParams.allowed)==null?void 0:t.length)>0),r=Boolean(e.subscribeParams.subscribeToRoles&&((i=e.subscribeParams.subscribeToRoles)==null?void 0:i.length)>0);return s||r}doesLocalPeerNeedWebRTC(){var e;let t=(e=this.store.getLocalPeer())==null?void 0:e.role;return t?this.doesRoleNeedWebRTC(t):!0}setTransportStateForConnect(){if(this.state===I.Failed&&(this.state=I.Disconnected),this.state!==I.Disconnected&&this.state!==I.Reconnecting)throw p.WebsocketMethodErrors.AlreadyJoined(g.JOIN,`Cannot join a meeting in ${this.state} state`);this.state===I.Disconnected&&(this.state=I.Connecting,this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i=this.getAdditionalAnalyticsProperties(),s;switch(t){case R.ConnectFailed:s=C.connect(e,i);break;case R.SignalDisconnect:s=C.disconnect(e,i);break;case R.JoinWSMessageFailed:s=C.join({error:e,time:this.analyticsTimer.getTimeTaken(P.JOIN),init_response_time:this.analyticsTimer.getTimeTaken(P.INIT),ws_connect_time:this.analyticsTimer.getTimeTaken(P.WEBSOCKET_CONNECT),on_policy_change_time:this.analyticsTimer.getTimeTaken(P.ON_POLICY_CHANGE),local_tracks_time:this.analyticsTimer.getTimeTaken(P.LOCAL_TRACKS),retries_join:this.joinRetryCount});break;case R.PublishIceConnectionFailed:s=C.publish({error:e});break;case R.SubscribeIceConnectionFailed:s=C.subscribeFail(e);break}this.eventBus.analytics.publish(s)}getAdditionalAnalyticsProperties(){var e,t,i,s,r,n,a,d;let c=us(),h=typeof document<"u"&&document.hidden,u=this.store.getRemoteVideoTracks().filter(_=>_.degraded).length,v=(s=(i=(t=(e=this.getWebrtcInternals())==null?void 0:e.getCurrentStats())==null?void 0:t.getLocalPeerStats())==null?void 0:i.publish)==null?void 0:s.bitrate,T=(d=(a=(n=(r=this.getWebrtcInternals())==null?void 0:r.getCurrentStats())==null?void 0:n.getLocalPeerStats())==null?void 0:a.subscribe)==null?void 0:d.bitrate;return{network_info:c,document_hidden:h,num_degraded_tracks:u,bitrate:{publish:v,subscribe:T},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function yt(e){if(!e||e.length===0)throw p.InitAPIErrors.InvalidTokenFormat(g.INIT,"Token cannot be an empty string or undefined or null");let t=e.split(".");if(t.length!==3)throw p.InitAPIErrors.InvalidTokenFormat(g.INIT,"Expected 3 '.' separate fields - header, payload and signature respectively");let i=atob(t[1]);try{let s=JSON.parse(i);return{roomId:s.room_id,userId:s.user_id,role:s.role}}catch(s){throw p.InitAPIErrors.InvalidTokenFormat(g.INIT,`couldn't parse to json - ${s.message}`)}}var vs=class{constructor(e,t){this.id=e,this.store=t,this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]}}get localPeer(){return this.store.getLocalPeer()}get peers(){return this.store.getPeers()}},St={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},gs=class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=f({},St),this.handleAudioPaused=s=>{var r;let n=(r=s.target.srcObject)==null?void 0:r.getAudioTracks()[0];if(!n?.enabled)return;o.d(this.TAG,"Audio Paused",s.target.id);let a=this.store.getTrackById(s.target.id);a&&(Mt()?setTimeout(()=>l(this,null,function*(){a&&(yield this.playAudioFor(a))}),500):this.autoPausedTracks.add(a))},this.handleTrackUpdate=({track:s,enabled:r})=>{var n;(n=window.HMS)!=null&&n.AUDIO_SINK&&(r?(s.addSink(),this.playAudioFor(s)):s.removeSink()),o.d(this.TAG,"Track updated",`${s}`)},this.handleTrackAdd=s=>l(this,[s],function*({track:r,peer:n}){var a,d,c;let h=document.createElement("audio");h.style.display="none",h.id=r.trackId,h.addEventListener("pause",this.handleAudioPaused),r.setAudioElement(h),r.setVolume(this.volume),o.d(this.TAG,"Audio track added",`${r}`),(a=this.audioSink)==null||a.append(h),this.outputDevice&&(yield r.setOutputDevice(this.outputDevice)),(d=window.HMS)!=null&&d.AUDIO_SINK?r.enabled?r.addSink():r.removeSink():h.srcObject=new MediaStream([r.nativeTrack]),(c=this.listener)==null||c.onTrackUpdate(D.TRACK_ADDED,r,n),yield this.handleAutoplayError(r)}),this.handleAutoplayError=s=>l(this,null,function*(){if(this.state.autoplayFailed===void 0&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise(r=>{this.playAudioFor(s).then(r)})),yield this.state.autoplayCheckPromise),this.state.autoplayFailed){this.autoPausedTracks.add(s);return}yield this.playAudioFor(s)}),this.handleAudioDeviceChange=s=>{s.error||!s.selection||s.type==="video"||this.unpauseAudioTracks()},this.handleTrackRemove=s=>{this.autoPausedTracks.delete(s);let r=document.getElementById(s.trackId);r&&(r.removeEventListener("pause",this.handleAudioPaused),r.srcObject=null,r.remove(),s.setAudioElement(null)),this.audioSink&&this.audioSink.childElementCount===0&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),o.d(this.TAG,"Audio track removed",`${s}`)},this.unpauseAudioTracks=()=>l(this,null,function*(){let s=[];this.autoPausedTracks.forEach(r=>{s.push(this.playAudioFor(r))}),yield Promise.all(s)}),this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){this.store.updateAudioOutputVolume(e),this.volume=e}unblockAutoplay(){return l(this,null,function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()})}init(e){if(this.state.initialized)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${Di()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t}cleanUp(){var e;(e=this.audioSink)==null||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=f({},St)}playAudioFor(e){return l(this,null,function*(){let t=e.getAudioElement();if(!t){o.w(this.TAG,"No audio element found on track",e.trackId);return}try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),o.d(this.TAG,"Played track",`${e}`)}catch(i){this.autoPausedTracks.add(e),o.e(this.TAG,"Failed to play track",`${e}`,i);let s=i;if(!this.state.autoplayFailed&&s.name==="NotAllowedError"){this.state.autoplayFailed=!0;let r=p.TracksErrors.AutoplayBlocked(g.AUTOPLAY,"");r.addNativeError(s),this.eventBus.analytics.publish(C.autoplayError()),this.eventBus.autoplayError.publish(r)}}})}},ps=class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.updateOutputDevice=s=>l(this,null,function*(){let r=this.audioOutput.find(n=>n.deviceId===s);return r&&(this.outputDevice=r,yield this.store.updateAudioOutputDevice(r),Y.updateSelection("audioOutput",{deviceId:r.deviceId,groupId:r.groupId})),r}),this.getCurrentSelection=()=>{var s,r;let n=this.store.getLocalPeer(),a=this.createIdentifier((s=n?.audioTrack)==null?void 0:s.getMediaTrackSettings()),d=this.createIdentifier((r=n?.videoTrack)==null?void 0:r.getMediaTrackSettings()),c=this.audioInput.find(u=>this.createIdentifier(u)===a),h=this.videoInput.find(u=>this.createIdentifier(u)===d);return{audioInput:c,videoInput:h,audioOutput:this.outputDevice}},this.computeChange=(s,r)=>s.length!==r.length?!0:r.some(n=>!s.includes(this.createIdentifier(n))),this.enumerateDevices=()=>l(this,null,function*(){try{let s=yield navigator.mediaDevices.enumerateDevices(),r=this.videoInput.map(this.createIdentifier),n=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],s.forEach(a=>{a.kind==="audioinput"&&a.label?(this.hasMicrophonePermission=!0,this.audioInput.push(a)):a.kind==="audiooutput"?this.audioOutput.push(a):a.kind==="videoinput"&&a.label&&(this.hasWebcamPermission=!0,this.videoInput.push(a))}),this.videoInputChanged=this.computeChange(r,this.videoInput),this.audioInputChanged=this.computeChange(n,this.audioInput),Y.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(s){o.e(this.TAG,"Failed enumerating devices",s)}}),this.handleDeviceChange=()=>l(this,null,function*(){yield this.enumerateDevices(),this.eventBus.analytics.publish(C.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})),this.logDevices("After Device Change");let s=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(s?.audioTrack),yield this.handleVideoInputDeviceChange(s?.videoTrack)}),this.handleAudioInputDeviceChange=s=>l(this,null,function*(){if(!s){o.d(this.TAG,"No Audio track on local peer");return}if(!this.audioInputChanged){o.d(this.TAG,"No Change in AudioInput Device");return}let r=this.getNewAudioInputDevice();if(!r||!r.deviceId){o.w(this.TAG,"Audio device not found");return}let{settings:n}=s,a=new se().codec(n.codec).maxBitrate(n.maxBitrate).deviceId(r.deviceId).build();try{yield s.setSettings(a,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:r,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(d){o.e(this.TAG,"[Audio Device Change]",d),this.eventBus.analytics.publish(C.deviceChange({selection:{audioInput:r},devices:this.getDevices(),error:d})),this.eventBus.deviceChange.publish({error:d,selection:r,type:"audioInput",devices:this.getDevices()})}}),this.handleVideoInputDeviceChange=s=>l(this,null,function*(){if(!s){o.d(this.TAG,"No video track on local peer");return}if(!this.videoInputChanged){o.d(this.TAG,"No Change in VideoInput Device");return}let r=this.videoInput[0];if(!r||!r.deviceId){o.w(this.TAG,"Video device not found");return}let{settings:n}=s,a=new q().codec(n.codec).maxBitrate(n.maxBitrate).maxFramerate(n.maxFramerate).setWidth(n.width).setHeight(n.height).deviceId(r.deviceId).build();try{yield s.setSettings(a,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:r,type:"video"}),this.logDevices("Video Device Change Success")}catch(d){o.e(this.TAG,"[Video Device Change]",d),this.eventBus.analytics.publish(C.deviceChange({selection:{videoInput:r},devices:this.getDevices(),error:d})),this.eventBus.deviceChange.publish({error:d,type:"video",selection:r,devices:this.getDevices()})}});let i=({enabled:s,track:r})=>s&&r.source==="regular";this.eventBus.localVideoEnabled.waitFor(i).then(()=>l(this,null,function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})),this.eventBus.localAudioEnabled.waitFor(i).then(()=>l(this,null,function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))}init(e=!1){return l(this,null,function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(C.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))})}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanUp(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find(t=>t.deviceId==="default");return e?this.audioInput.find(t=>t.label!==e.label&&e.label.includes(t.label)):this.audioInput[0]}setOutputDevice(e=!1){return l(this,null,function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find(s=>this.createIdentifier(s)===i),this.outputDevice||(this.outputDevice=this.audioOutput.find(s=>s.deviceId==="default")||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()})})}getAudioOutputDeviceMatchingInput(e){var t,i;let s=((i=(t=this.store.getConfig())==null?void 0:t.settings)==null?void 0:i.speakerAutoSelectionBlacklist)||[];if(s==="all")return;let r=e?.label.toLowerCase()||"";if(!s.some(n=>r.includes(n.toLowerCase()))&&e?.groupId)return this.audioOutput.find(n=>e.deviceId!=="default"&&n.label===e.label)}logDevices(e=""){o.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}},ms=class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return l(this,null,function*(){yield this.audioSinkManager.unblockAutoplay()})}},At="AnalyticsEventsService",Ts=class{constructor(e){this.store=e,this.bufferSize=tt,this.transport=null,this.pendingEvents=[],this.level=Fe.INFO}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let t=this.pendingEvents.shift();o.d(At,"Max buffer size reached","Removed event to accommodate new events",t)}return this}flushFailedClientEvents(){Se.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=(e=this.store.getLocalPeer())==null?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(t){o.w(At,"Flush Failed",t)}}sendClientEventOnHTTP(e){var t,i,s,r;let n=this.store.getRoom(),a=this.store.getLocalPeer();e.metadata.token=(t=this.store.getConfig())==null?void 0:t.authToken,e.metadata.peer={session_id:n.sessionId,room_id:n.id,room_name:n.name,template_id:n.templateId,joined_at:(i=n.joinedAt)==null?void 0:i.getTime(),session_started_at:(s=n.startedAt)==null?void 0:s.getTime(),role:(r=a?.role)==null?void 0:r.name,user_name:a?.name,user_data:a?.metadata},Se.sendEvent(e)}},Es=class{constructor(e){this.store=e,this.primitiveComparator=(t,i)=>t===i?0:Number(t)-Number(i),this.stringComparator=(t,i)=>t===i?0:t<i?-1:1}getPeerComparators(){return{videoEnabled:(e,t)=>{var i,s;return this.primitiveComparator(Boolean((i=e.videoTrack)==null?void 0:i.enabled),Boolean((s=t.videoTrack)==null?void 0:s.enabled))},audioEnabled:(e,t)=>{var i,s;return this.primitiveComparator(Boolean((i=e.audioTrack)==null?void 0:i.enabled),Boolean((s=t.audioTrack)==null?void 0:s.enabled))},screenShare:(e,t)=>this.primitiveComparator(e.auxiliaryTracks.some(i=>i.source==="screen"),t.auxiliaryTracks.some(i=>i.source==="screen")),audioLevel:(e,t)=>{var i,s;return this.primitiveComparator(((i=this.store.getSpeakers().find(r=>r.peer&&r.peer.peerId===e?.peerId))==null?void 0:i.audioLevel)||-1,((s=this.store.getSpeakers().find(r=>r.peer&&r.peer.peerId===t?.peerId))==null?void 0:s.audioLevel)||-1)},rolePriority:(e,t)=>{var i,s;return this.primitiveComparator(((i=t.role)==null?void 0:i.priority)||0,((s=e.role)==null?void 0:s.priority)||0)}}}getTrackComparators(){return{video:(e,t)=>this.primitiveComparator(e.type===w.VIDEO,t.type===w.VIDEO),audio:(e,t)=>this.primitiveComparator(e.type===w.AUDIO,t.type===w.AUDIO),enabled:(e,t)=>this.primitiveComparator(Boolean(e.enabled),Boolean(t.enabled)),peerAudioLevel:(e,t)=>{let i=this.store.getPeerByTrackId(e.trackId),s=this.store.getPeerByTrackId(t.trackId);return this.getPeerComparators().audioLevel(i,s)},audioLevel:(e,t)=>{var i,s;return this.primitiveComparator(((i=this.store.getSpeakers().find(r=>r.track.trackId===e.trackId))==null?void 0:i.audioLevel)||0,((s=this.store.getSpeakers().find(r=>r.track.trackId===t.trackId))==null?void 0:s.audioLevel)||0)},screenShare:(e,t)=>this.primitiveComparator(e.source==="screen",t.source==="screen"),rolePriority:(e,t)=>{var i,s,r,n;return this.primitiveComparator(((s=(i=this.store.getPeerByTrackId(t.trackId))==null?void 0:i.role)==null?void 0:s.priority)||0,((n=(r=this.store.getPeerByTrackId(e.trackId))==null?void 0:r.role)==null?void 0:n.priority)||0)}}}},fs=class{constructor(){this.comparator=new Es(this),this.knownRoles={},this.peers={},this.tracks={},this.peerTrackStates={},this.speakers=[],this.videoLayers=null,this.screenshareLayers=null,this.roleDetailsArrived=!1,this.env=F.PROD,this.userAgent=Me(this.env)}getConfig(){return this.config}getEnv(){return this.env}getPublishParams(){return this.publishParams}getComparator(){return this.comparator}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter(e=>!e.isLocal)}getPeers(){return Object.values(this.peers)}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Object.values(this.tracks)}getVideoTracks(){return this.getTracks().filter(e=>e.type===w.VIDEO)}getRemoteVideoTracks(){return this.getTracks().filter(e=>e instanceof Re)}getAudioTracks(){return this.getTracks().filter(e=>e.type===w.AUDIO)}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return t?.videoTrack&&i.push(t.videoTrack),t?.audioTrack&&i.push(t.audioTrack),i.concat(t?.auxiliaryTracks||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}getTrackById(e){var t,i;let s=this.tracks[e];if(s)return s;let r=this.getLocalPeer();if(r){if((t=r.audioTrack)!=null&&t.isPublishedTrackId(e))return r.audioTrack;if((i=r.videoTrack)!=null&&i.isPublishedTrackId(e))return r.videoTrack}}getPeerByTrackId(e){let t=this.tracks[e];return t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map(e=>e.peer)}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=Me(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){this.knownRoles=e,this.roleDetailsArrived=!0,this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,s;if(Y.rememberDevices(Boolean(e.rememberDeviceSelection)),e.rememberDeviceSelection){let r=Y.getSelection();r&&(e.settings||(e.settings={}),(t=r.audioInput)!=null&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||r.audioInput.deviceId),(i=r.audioOutput)!=null&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||r.audioOutput.deviceId),(s=r.videoInput)!=null&&s.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||r.videoInput.deviceId))}this.config=e,this.setEnv()}setPublishParams(e){this.publishParams=e}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks[e.trackId]=e}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){delete this.tracks[e]}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){this.getAudioTracks().forEach(t=>t.setVolume(e))}updateAudioOutputDevice(e){return l(this,null,function*(){let t=[];this.getAudioTracks().forEach(i=>{t.push(i.setOutputDevice(e))}),yield Promise.all(t)})}getSubscribeDegradationParams(){var e,t;let i=(t=(e=this.getLocalPeer())==null?void 0:e.role)==null?void 0:t.subscribeParams.subscribeDegradation;if(i&&Object.keys(i).length>0)return i}getSimulcastLayers(e){var t,i;return e==="screen"?((t=this.screenshareLayers)==null?void 0:t.layers)||[]:((i=this.videoLayers)==null?void 0:i.layers)||[]}getSimulcastDimensions(e){let t=e==="screen"?this.screenshareLayers:this.videoLayers,i=t?.width,s=t?.height;return{width:i,height:s}}convertSimulcastLayers(e){return O(f({},e),{layers:(e.layers||[]).map(t=>O(f({},t),{maxBitrate:t.maxBitrate*1e3}))})}setVideoSimulcastLayers(e){this.videoLayers=this.convertSimulcastLayers(e)}setScreenshareSimulcastLayers(e){this.screenshareLayers=this.convertSimulcastLayers(e)}getSimulcastDefinitionsForPeer(e,t){var i;if(!e.role)return[];let s=this.getPolicyForRole(e.role.name).publishParams,r;t==="regular"?r=s.videoSimulcastLayers:t==="screen"&&(r=s.screenSimulcastLayers);let n=r?.width,a=r?.height;return((i=r?.layers)==null?void 0:i.map(d=>{let c=Vt[d.rid],h={width:n&&d.scaleResolutionDownBy?n/d.scaleResolutionDownBy:void 0,height:a&&d.scaleResolutionDownBy?a/d.scaleResolutionDownBy:void 0};return{layer:c,resolution:h}}))||[]}cleanUp(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach(e=>{var t;if(!e.role){(t=this.errorListener)==null||t.onError(p.GenericErrors.InvalidRole(g.VALIDATION,""));return}e.role=this.getPolicyForRole(e.role.name)})}setEnv(){var e;let t=((e=this.config)==null?void 0:e.initEndpoint).split("https://")[1],i=F.PROD;t.startsWith(F.PROD)?i=F.PROD:t.startsWith(F.QA)?i=F.QA:t.startsWith(F.DEV)&&(i=F.DEV),this.env=i,Se.setEnv(i)}},ks=class{constructor(e,t,i,s,r){this.store=e,this.transport=t,this.publish=i,this.removeAuxiliaryTrack=s,this.listener=r,this.handleLocalPeerRoleUpdate=n=>l(this,[n],function*({oldRole:a,newRole:d}){var c,h;let u=this.store.getLocalPeer();if(!u)return;let v=new Set(a.publishParams.allowed||[]),T=new Set(d.publishParams.allowed||[]),_=this.removeTrack(v,T,"video"),W=this.removeTrack(v,T,"audio"),z=this.removeTrack(v,T,"screen");yield this.removeVideoTracks(_),yield this.removeAudioTrack(W),yield this.removeScreenTracks(z),this.store.setPublishParams(d.publishParams);let bs=((c=this.store.getConfig())==null?void 0:c.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};yield this.publish(O(f({},bs),{isAudioMuted:!0,isVideoMuted:!0})),(h=this.listener)==null||h.onPeerUpdate(B.ROLE_UPDATED,u)})}removeVideoTracks(e){return l(this,null,function*(){var t;if(!e)return;let i=this.store.getLocalPeer();i?.videoTrack&&(yield this.transport.unpublish([i.videoTrack]),(t=this.listener)==null||t.onTrackUpdate(D.TRACK_REMOVED,i.videoTrack,i),i.videoTrack=void 0),yield this.removeAuxTracks(s=>s.source!=="screen"&&s.type==="video")})}removeAudioTrack(e){return l(this,null,function*(){var t;if(!e)return;let i=this.store.getLocalPeer();i?.audioTrack&&(yield this.transport.unpublish([i.audioTrack]),(t=this.listener)==null||t.onTrackUpdate(D.TRACK_REMOVED,i.audioTrack,i),i.audioTrack=void 0),yield this.removeAuxTracks(s=>s.source!=="screen"&&s.type==="audio")})}removeScreenTracks(e){return l(this,null,function*(){!e||(yield this.removeAuxTracks(t=>t.source==="screen"))})}removeAuxTracks(e){return l(this,null,function*(){let t=this.store.getLocalPeer();if(t?.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let s of i)e(s)&&(yield this.removeAuxiliaryTrack(s.trackId))}})}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}},xs=class extends null{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},It=class{constructor(e){this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){this.audioContext.state==="suspended"&&(o.d(this.TAG,"AudioContext is resumed"),this.audioContext.resume())}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){this.audioContext.state!=="closed"&&this.audioContext.close()}get TAG(){return"AudioContextManager"}},ys=class extends null{constructor(){super(...arguments),this.audioElement=null,this.seeked=!1}play(e){return l(this,null,function*(){return this.audioElement=this.getAudioElement(),new Promise((t,i)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let s=`Error loading ${e}`;o.e(this.TAG,s),this.stop(),i(s)},this.audioElement.oncanplaythrough=()=>l(this,null,function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let s=this.audioContextManager.getAudioTrack();this.track=s,t([s])}}catch(s){o.e(this.TAG,"Error playing audio",e,s.message),i(s)}}),this.audioElement.onseeked=()=>{this.seeked=!0}})})}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement}stop(){var e,t,i;(e=this.audioElement)==null||e.pause(),(t=this.audioElement)==null||t.removeAttribute("src"),this.audioElement=null,(i=this.audioContextManager)==null||i.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new It(e),e}get TAG(){return"PlaylistAudioManager"}},Ss=class extends null{constructor(){super(...arguments),this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,t,i;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&((i=this.canvasContext)==null||i.drawImage(this.videoElement,0,0,(e=this.canvas)==null?void 0:e.width,(t=this.canvas)==null?void 0:t.height),this.timer=setTimeout(()=>{this.drawImage()},1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise((t,i)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let s=`Error loading ${e}`;o.e(this.TAG,s),this.stop(),i(s)},this.videoElement.oncanplaythrough=()=>l(this,null,function*(){var s,r,n;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,this.tracks.length===0){this.clearCanvasAndTracks();let a=this.canvas.captureStream();if(!a){o.e(this.TAG,"Browser does not support captureStream");return}this.videoElement.onplay=this.drawImage,this.audioContextManager.resumeContext(),yield this.videoElement.play();let d=this.audioContextManager.getAudioTrack();a.addTrack(d),a.getTracks().forEach(c=>{this.tracks.push(c)}),t(this.tracks)}else this.seeked?(this.seeked=!1,(n=this.canvasContext)==null||n.drawImage(this.videoElement,0,0,(s=this.canvas)==null?void 0:s.width,(r=this.canvas)==null?void 0:r.height)):(yield this.videoElement.play(),t(this.tracks))}catch(a){o.e(this.TAG,"Error playing video",e,a.message),i(a)}}),this.videoElement.onseeked=()=>{this.seeked=!0}})}getTracks(){return this.tracks.map(e=>e.id)}getElement(){return this.videoElement}stop(){var e,t,i;(e=this.videoElement)==null||e.pause(),(t=this.videoElement)==null||t.removeAttribute("src"),this.videoElement=null,(i=this.audioContextManager)==null||i.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],(e=this.canvasContext)==null||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new It(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}get TAG(){return"PlaylistVideoManager"}},Ae={audio:{list:[],currentIndex:-1,isAutoplayOn:!0},video:{list:[],currentIndex:-1,isAutoplayOn:!0}},As=class extends null{constructor(e,t){super(),this.sdk=e,this.eventBus=t,this.state={audio:f({},Ae.audio),video:f({},Ae.video)},this.TAG="[PlaylistManager]",this.handlePausePlaylist=i=>l(this,[i],function*({enabled:s,track:r}){var n;if(s)return;let a;r.source==="audioplaylist"&&(a=y.audio),r.source==="videoplaylist"&&(a=y.video),a&&((n=this.getElement(a))==null||n.pause())}),this.addTrack=(i,s)=>l(this,null,function*(){yield this.sdk.addTrack(i,s),o.d(this.TAG,"Playlist track added",ge(i))}),this.removeTrack=i=>l(this,null,function*(){yield this.sdk.removeTrack(i),o.d(this.TAG,"Playlist track removed",i)}),this.audioManager=new ys,this.videoManager=new Ss,this.addListeners()}getList(e=y.audio){return this.state[e].list}setList(e){if(!e||e.length===0){o.w(this.TAG,"Please pass in a list of HMSPlaylistItem's");return}e.forEach(t=>{this.state[t.type].list.includes(t)||this.state[t.type].list.push(t)})}clearList(e){return l(this,null,function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]})}removeItem(e,t){return l(this,null,function*(){let{list:i,currentIndex:s}=this.state[t],r=i.findIndex(n=>e===n.id);return r>-1?(s===r&&this.isPlaying(t)&&(yield this.stop(t)),i.splice(r,1),!0):!1})}seek(e,t=y.audio){let{currentIndex:i}=this.state[t];if(i===-1)throw p.PlaylistErrors.NoEntryToPlay(g.PLAYLIST,"No item is currently playing");let s=this.getElement(t);if(s){let r=Math.max(s.currentTime+e,0);s.currentTime=Math.min(r,s.duration)}}seekTo(e,t=y.audio){let{currentIndex:i}=this.state[t];if(i===-1)throw p.PlaylistErrors.NoEntryToPlay(g.PLAYLIST,"No item is currently playing");if(e<0)throw Error("value cannot be negative");let s=this.getElement(t);s&&(s.currentTime=Math.min(e,s.duration))}setVolume(e,t=y.audio){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let i=this.getElement(t);i&&(i.volume=e*.01)}getVolume(e=y.audio){let t=this.getElement(e);return t?t.volume*100:0}getCurrentTime(e=y.audio){let t=this.getElement(e);return t?.currentTime||0}getCurrentIndex(e=y.audio){return this.state[e].currentIndex}getCurrentProgress(e=y.audio){var t;let{list:i,currentIndex:s}=this.state[e],r=(t=i[s])==null?void 0:t.url,n=this.getElement(e);return!r||!n?0:Math.floor(100*(n.currentTime/n.duration))}getCurrentSelection(e=y.audio){let{list:t,currentIndex:i}=this.state[e];if(i!==-1)return t[i]}isPlaying(e=y.audio){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e=y.audio,t){this.state[e].isAutoplayOn=t}getPlaybackRate(e=y.audio){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e=y.audio,t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let i=this.getElement(e);i&&(i.playbackRate=t)}setEnabled(e,t){return l(this,arguments,function*(i,{id:s,type:r=y.audio}){let n=this.state[r].list.findIndex(d=>d.id===s);if(!s||n===-1){o.w(this.TAG,"Pass a valid id");return}let a=this.state[r].list[n].url;i?yield this.play(a,r):yield this.pause(a,r),this.state[r].currentIndex=n,this.setDuration(r)})}playNext(){return l(this,arguments,function*(e=y.audio){let{list:t,currentIndex:i}=this.state[e];if(i>=t.length-1)throw p.PlaylistErrors.NoEntryToPlay(g.PLAYLIST,"Reached end of playlist");yield this.play(t[i+1].url,e),this.state[e].currentIndex=i+1,this.setDuration(e)})}playPrevious(){return l(this,arguments,function*(e=y.audio){let{list:t,currentIndex:i}=this.state[e];if(i<=0)throw p.PlaylistErrors.NoEntryToPlay(g.PLAYLIST,"Reached start of playlist");yield this.play(t[i-1].url,e),this.state[e].currentIndex=i-1,this.setDuration(e)})}stop(){return l(this,arguments,function*(e=y.audio){var t;let i=e===y.audio?this.audioManager:this.videoManager;(t=i.getElement())==null||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1})}cleanup(){this.state={audio:f({},Ae.audio),video:f({},Ae.video)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",()=>{try{e({type:y.video,progress:this.getCurrentProgress(y.video)})}catch{o.e(this.TAG,"Error in onProgress callback")}}),this.audioManager.on("progress",()=>{try{e({type:y.audio,progress:this.getCurrentProgress(y.audio)})}catch{o.e(this.TAG,"Error in onProgress callback")}})}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e=y.audio){return e===y.audio?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return l(this,arguments,function*(e=y.audio){let t=(e===y.audio?this.audioManager:this.videoManager).getTracks();for(let i of t)yield this.removeTrack(i)})}play(e){return l(this,arguments,function*(t,i=y.audio){let s=i===y.audio?this.audioManager:this.videoManager,r=s.getElement();if(this.isItemCurrentlyPlaying(t,i)){o.w(this.TAG,`The ${i} is currently playing`);return}if(r?.src.includes(t))yield r.play();else{r?.pause();let n=yield s.play(t);for(let a of n)yield this.addTrack(a,i===y.audio?"audioplaylist":"videoplaylist")}})}isItemCurrentlyPlaying(e,t){let i=this.getElement(t);return!!(i&&!i.paused&&i.src.includes(e))}setDuration(e=y.audio){let t=this.getElement(e),{list:i,currentIndex:s}=this.state[e];i[s]&&(i[s].duration=t?.duration||0),this.emit("newTrackStart",i[s])}pause(e){return l(this,arguments,function*(t,i=y.audio){let s=this.getElement(i);s&&!s.paused&&s.src.includes(t)?(s.pause(),o.d(this.TAG,"paused url",t)):o.w(this.TAG,"The passed in url is not currently playing")})}addListeners(){this.audioManager.on("ended",()=>this.handleEnded(y.audio)),this.videoManager.on("ended",()=>this.handleEnded(y.video)),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return l(this,arguments,function*(e=y.audio){let{list:t,currentIndex:i,isAutoplayOn:s}=this.state[e];i===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):s?this.playNext(e):yield this.pause(t[i].url,e),this.emit("currentTrackEnded",t[i])})}},M=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=i=>{this.eventEmitter.emit(this.eventName,i)},this.subscribe=i=>{this.eventEmitter.on(this.eventName,i)},this.subscribeOnce=i=>{this.eventEmitter.once(this.eventName,i)},this.unsubscribe=i=>{this.eventEmitter.off(this.eventName,i)},this.waitFor=i=>this.eventEmitter.waitFor(this.eventName,{filter:i}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},Is=class{constructor(){this.eventEmitter=new Oi,this.deviceChange=new M(L.DEVICE_CHANGE,this.eventEmitter),this.localAudioEnabled=new M(L.LOCAL_AUDIO_ENABLED,this.eventEmitter),this.localVideoEnabled=new M(L.LOCAL_VIDEO_ENABLED,this.eventEmitter),this.statsUpdate=new M(L.STATS_UPDATE,this.eventEmitter),this.trackDegraded=new M(L.TRACK_DEGRADED,this.eventEmitter),this.trackRestored=new M(L.TRACK_RESTORED,this.eventEmitter),this.trackAudioLevelUpdate=new M(L.TRACK_AUDIO_LEVEL_UPDATE,this.eventEmitter),this.audioPluginFailed=new M(L.AUDIO_PLUGIN_FAILED,this.eventEmitter),this.localAudioSilence=new M(L.LOCAL_AUDIO_SILENCE,this.eventEmitter),this.analytics=new M(L.ANALYTICS,this.eventEmitter),this.policyChange=new M(L.POLICY_CHANGE,this.eventEmitter),this.localRoleUpdate=new M(L.LOCAL_ROLE_UPDATE,this.eventEmitter),this.audioTrackUpdate=new M(L.AUDIO_TRACK_UPDATE,this.eventEmitter),this.audioTrackAdded=new M(L.AUDIO_TRACK_ADDED,this.eventEmitter),this.audioTrackRemoved=new M(L.AUDIO_TRACK_REMOVED,this.eventEmitter),this.autoplayError=new M(L.AUTOPLAY_ERROR,this.eventEmitter)}},Ps=class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="NetworkTestManager",this.controller=new AbortController,this.start=i=>l(this,null,function*(){var s;if(!i)return;let{url:r,timeout:n,scoreMap:a}=i,d=this.controller.signal,c=Date.now(),h=0,u=J(n).then(()=>{this.controller.abort()});try{let v=(s=(yield fetch(`${r}?${Date.now()}`,{signal:d})).body)==null?void 0:s.getReader();if(!v)throw Error("unable to process request");let T=()=>l(this,null,function*(){if(v)try{let _=!1;for(;!_;){let{value:W,done:z}=yield v.read();_=z,W&&(h+=W.byteLength,this.sendScore({scoreMap:a,downloadedSize:h,startTime:c}))}}catch(_){o.e(this.TAG,_)}});return Promise.race([T(),u]).then(()=>{this.sendScore({scoreMap:a,downloadedSize:h,startTime:c,finished:!0})}).catch(_=>{o.e(this.TAG,_),this.updateScoreToListener(0),this.eventBus.analytics.publish(C.previewNetworkQuality({error:_.message}))})}catch(v){o.e(this.TAG,v),v.name!=="AbortError"&&(this.updateScoreToListener(0),this.eventBus.analytics.publish(C.previewNetworkQuality({error:v.message})))}}),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:i,downloadedSize:s,startTime:r,finished:n=!1})=>{let a=(Date.now()-r)/1e3,d=s/1024/a*8,c=-1;for(let h in i){let u=i[h];d>=u.low&&(!u.high||d<=u.high)&&(c=Number(h))}this.updateScoreToListener(c),n&&this.eventBus.analytics.publish(C.previewNetworkQuality({score:c,downLink:d.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,(i=(t=this.listener)==null?void 0:t.onNetworkQuality)==null||i.call(t,e))}},Pt={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},Ct={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,deviceManagersInitialised:!1},Vs=class{constructor(){this.TAG="[HMSSdk]:",this.transportState=I.Disconnected,this.analyticsTimer=new Ki,this.sdkState=f({},Ct),this.handleAutoplayError=e=>{var t,i;(i=(t=this.errorListener)==null?void 0:t.onError)==null||i.call(t,e)},this.observer={onNotification:e=>{if(e.method===S.PEER_LEAVE_REQUEST){this.handlePeerLeaveRequest(e.params);return}e.method===S.POLICY_CHANGE&&this.analyticsTimer.end(P.ON_POLICY_CHANGE),this.notificationManager.handleNotification(e,this.sdkState.isReconnecting)},onTrackAdd:e=>{this.notificationManager.handleTrackAdd(e)},onTrackRemove:e=>{this.notificationManager.handleTrackRemove(e)},onTrackDegrade:e=>{var t,i;o.d(this.TAG,"Sending Track Update Track Degraded",e),(i=this.listener)==null||i.onTrackUpdate(D.TRACK_DEGRADED,e,(t=this.store)==null?void 0:t.getPeerByTrackId(e.trackId))},onTrackRestore:e=>{var t,i;o.d(this.TAG,"Sending Track Update Track Restored",e),(i=this.listener)==null||i.onTrackUpdate(D.TRACK_RESTORED,e,(t=this.store)==null?void 0:t.getPeerByTrackId(e.trackId))},onFailure:e=>{var t;(t=this.errorListener)==null||t.onError(e)},onStateChange:(e,t)=>l(this,null,function*(){var i,s,r,n;switch(e){case I.Preview:case I.Joined:this.transportState===I.Reconnecting&&((i=this.listener)==null||i.onReconnected());break;case I.Failed:yield this.leave(),(r=(s=this.errorListener)==null?void 0:s.onError)==null||r.call(s,t),this.sdkState.isReconnecting=!1;break;case I.Reconnecting:this.sdkState.isReconnecting=!0,(n=this.listener)==null||n.onReconnecting(t);break}this.transportState=e,o.d(this.TAG,"Transport State Change",this.transportState)})},this.handlePeerLeaveRequest=e=>{var t;let i=e.requested_by?this.store.getPeerById(e.requested_by):void 0,s={roomEnded:e.room_end,reason:e.reason,requestedBy:i};(t=this.listener)==null||t.onRemovedFromRoom(s),this.internalLeave(!1)},this.handleDeviceChange=e=>{var t,i,s,r,n,a;if(o.d(this.TAG,"Device Change event",e),(i=(t=this.deviceChangeListener)==null?void 0:t.onDeviceChange)==null||i.call(t,e),e.error&&e.type){let d=e.type.includes("audio")?(s=this.localPeer)==null?void 0:s.audioTrack:(r=this.localPeer)==null?void 0:r.videoTrack;(n=this.errorListener)==null||n.onError(e.error),[E.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,E.TracksErrors.DEVICE_IN_USE,E.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&d&&(d.setEnabled(!1),(a=this.listener)==null||a.onTrackUpdate(D.TRACK_MUTED,d,this.localPeer))}},this.handleAudioPluginError=e=>{var t;o.e(this.TAG,"Audio Plugin Error event",e),(t=this.errorListener)==null||t.onError(e)},this.handleLocalRoleUpdate=e=>l(this,[e],function*({oldRole:t,newRole:i}){var s;yield this.transport.handleLocalRoleUpdate({oldRole:t,newRole:i}),yield(s=this.roleChangeManager)==null?void 0:s.handleLocalPeerRoleUpdate({oldRole:t,newRole:i})}),this.getScreenshareSettings=e=>{let{screen:t}=this.store.getPublishParams(),i=this.store.getSimulcastDimensions("screen");return{video:new q().maxBitrate(t.bitRate,!1).codec(t.codec).maxFramerate(t.frameRate).setWidth(i?.width||t.width).setHeight(i?.height||t.height).build(),audio:e?void 0:new se().build()}},this.sendAudioPresenceFailed=()=>{let e=p.TracksErrors.NoAudioDetected(g.PREVIEW);this.sendAnalyticsEvent(C.audioDetectionFail(e,this.deviceManager.getCurrentSelection().audioInput))},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(C.join(O(f({error:t},this.analyticsTimer.getTimes(P.INIT,P.WEBSOCKET_CONNECT,P.ON_POLICY_CHANGE,P.LOCAL_TRACKS)),{time:this.analyticsTimer.getTimeTaken(P.JOIN),is_preview_called:e})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(C.preview(O(f({error:e},this.analyticsTimer.getTimes(P.INIT,P.WEBSOCKET_CONNECT,P.ON_POLICY_CHANGE,P.LOCAL_TRACKS)),{time:this.analyticsTimer.getTimeTaken(P.PREVIEW)})))},this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initStoreAndManagers(){if(this.sdkState.isInitialised){this.notificationManager.setListener(this.listener),this.audioSinkManager.setListener(this.listener);return}this.sdkState.isInitialised=!0,this.store=new fs,this.eventBus=new Is,this.networkTestManager=new Ps(this.eventBus,this.listener),this.playlistManager=new As(this,this.eventBus),this.notificationManager=new qi(this.store,this.eventBus,this.listener,this.audioListener),this.deviceManager=new ps(this.store,this.eventBus),this.audioSinkManager=new gs(this.store,this.deviceManager,this.eventBus),this.audioOutput=new ms(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new ke(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new Ts(this.store),this.transport=new hs(this.observer,this.deviceManager,this.store,this.localTrackManager,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,`Not connected - ${e}`)}refreshDevices(){return l(this,null,function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)})}getWebrtcInternals(){var e;return(e=this.transport)==null?void 0:e.getWebrtcInternals()}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return(e=this.store.getRoom())==null?void 0:e.recording}getRTMPState(){var e;return(e=this.store.getRoom())==null?void 0:e.rtmp}getHLSState(){var e;return(e=this.store.getRoom())==null?void 0:e.hls}get localPeer(){var e;return(e=this.store)==null?void 0:e.getLocalPeer()}preview(e,t){return l(this,null,function*(){if(Xe(),Ze(),this.sdkState.isPreviewInProgress)return Promise.reject(p.GenericErrors.PreviewAlreadyInProgress(g.PREVIEW,"Preview already called"));this.analyticsTimer.start(P.PREVIEW),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then(()=>l(this,null,function*(){yield this.initDeviceManagers()}));let i=!1,s=!1,r=setTimeout(()=>{var n,a;(!i||!s)&&((a=(n=this.listener)==null?void 0:n.onNetworkQuality)==null||a.call(n,-1))},3e3);return new Promise((n,a)=>{let d=()=>l(this,null,function*(){var c;let h=yield this.localTrackManager.getTracksToPublish(e.settings||Pt);h.forEach(u=>this.setLocalPeerTrack(u)),(c=this.localPeer)!=null&&c.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end(P.PREVIEW),t.onPreview(this.store.getRoom(),h),this.sendPreviewAnalyticsEvent(),n()});this.eventBus.policyChange.subscribeOnce(d),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then(c=>{var h;i=!0,clearTimeout(r),c&&e.captureNetworkQualityInPreview&&this.networkTestManager.start((h=c.config)==null?void 0:h.networkHealth).then(()=>{s=!0})}).catch(c=>{var h;this.analyticsTimer.end(P.PREVIEW),(h=this.errorListener)==null||h.onError(c),this.sendPreviewAnalyticsEvent(c),this.sdkState.isPreviewInProgress=!1,a(c)})})})}join(e,t){return l(this,null,function*(){var i,s,r,n;if(Xe(),Ze(),this.sdkState.isPreviewInProgress)throw p.GenericErrors.NotReady(g.JOIN,"Preview is in progress, can't join");this.analyticsTimer.start(P.JOIN);let a=this.transportState===I.Preview,{roomId:d,userId:c,role:h}=yt(e.authToken);(i=this.networkTestManager)==null||i.stop(),(r=(s=this.localPeer)==null?void 0:s.audioTrack)==null||r.destroyAudioLevelMonitor(),this.listener=t,this.commonSetup(e,d,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(h),this.localPeer.customerUserId=c,this.localPeer.metadata=e.metaData):this.createAndAddLocalPeerToStore(e,h,c),this.roleChangeManager=new ks(this.store,this.transport,this.publish.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),o.d(this.TAG,"SDK Store",this.store),o.d(this.TAG,`\u23F3 Joining room ${d}`),o.time(`join-room-${d}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe),o.d(this.TAG,`\u2705 Joined room ${d}`),gt.resumeContext(),yield this.notifyJoin(),this.sendJoinAnalyticsEvent(a),[this.store.getPublishParams(),!this.sdkState.published,!he].every(u=>!!u)&&this.publish(e.settings||Pt).catch(u=>{var v;o.e(this.TAG,"Error in publish",u),(v=this.listener)==null||v.onError(u)})}catch(u){throw this.analyticsTimer.end(P.JOIN),(n=this.listener)==null||n.onError(u),this.sendJoinAnalyticsEvent(a,u),o.e(this.TAG,"Unable to join room",u),u}o.timeEnd(`join-room-${d}`)})}stringifyMetadata(e){e.metaData&&typeof e.metaData!="string"?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanUp(){var e,t;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanUp(),Y.cleanup(),this.playlistManager.cleanup(),o.cleanUp(),this.sdkState=f({},Ct),this.localPeer&&((e=this.localPeer.audioTrack)==null||e.cleanup(),this.localPeer.audioTrack=void 0,(t=this.localPeer.videoTrack)==null||t.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanUp(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.roleChangeManager.handleLocalPeerRoleUpdate)}leave(){return this.internalLeave()}internalLeave(e=!0){return l(this,null,function*(){var t,i;let s=this.store.getRoom();if(s){let r=s.id;(t=this.networkTestManager)==null||t.stop(),o.d(this.TAG,`\u23F3 Leaving room ${r}`),yield(i=this.transport)==null?void 0:i.leave(e),this.cleanUp(),o.d(this.TAG,`\u2705 Left room ${r}`)}})}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){let e=this.store.getPeers();return e.length<50&&o.d(this.TAG,`Got peers(${e.length})`,e.toString()),e}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return l(this,null,function*(){return yield this.sendMessageInternal({message:e,type:t})})}sendGroupMessage(e,t,i){return l(this,null,function*(){let s=this.store.getKnownRoles();if((t.filter(r=>s[r.name])||[]).length===0)throw p.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})})}sendDirectMessage(e,t,i){return l(this,null,function*(){var s;if(!this.store.getPeerById(t.peerId))throw p.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);if(((s=this.localPeer)==null?void 0:s.peerId)===t.peerId)throw p.GenericErrors.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:i})})}sendMessageInternal(e){return l(this,arguments,function*({recipientRoles:t,recipientPeer:i,type:s="chat",message:r}){if(r.replace(/\u200b/g," ").trim()==="")throw o.w(this.TAG,"sendMessage","Ignoring empty message send"),p.GenericErrors.ValidationFailed("Empty message not allowed");let n=new nt({sender:this.localPeer,type:s,message:r,recipientPeer:i,recipientRoles:t,time:new Date});o.d(this.TAG,"Sending Message: ",n);let a=yield this.transport.sendMessage(n);return n.time=new Date(a.timestamp),n})}startScreenShare(e){return l(this,arguments,function*(t,i={audioOnly:!1,videoOnly:!1}){var s,r,n;let a=this.store.getPublishParams();if(!a)return;let{allowed:d}=a;if(!(d&&d.includes("screen"))){o.e(this.TAG,`Role ${(s=this.localPeer)==null?void 0:s.role} cannot share screen`);return}if((n=(r=this.localPeer)==null?void 0:r.auxiliaryTracks)!=null&&n.find(h=>h.source==="screen"))throw Error("Cannot share multiple screens");let c=yield this.getScreenshareTracks(t,i);if(!this.localPeer){o.d(this.TAG,"Screenshared when not connected"),c.forEach(h=>{h.cleanup()});return}yield this.transport.publish(c),c.forEach(h=>{var u,v,T;h.peerId=(u=this.localPeer)==null?void 0:u.peerId,(v=this.localPeer)==null||v.auxiliaryTracks.push(h),(T=this.listener)==null||T.onTrackUpdate(D.TRACK_ADDED,h,this.localPeer)})})}stopEndedScreenshare(e){return l(this,null,function*(){o.d(this.TAG,"\u2705 Screenshare ended natively"),yield this.stopScreenShare(),e()})}stopScreenShare(){return l(this,null,function*(){var e;o.d(this.TAG,"\u2705 Screenshare ended from app");let t=(e=this.localPeer)==null?void 0:e.auxiliaryTracks.filter(i=>i.source==="screen");if(t)for(let i of t)yield this.removeTrack(i.trackId)})}addTrack(e,t="regular"){return l(this,null,function*(){var i,s,r,n;if(!e){o.w(this.TAG,"Please pass a valid MediaStreamTrack");return}if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find(v=>v.trackId===e.id))return;let a=e.kind,d=new MediaStream([e]),c=new fe(d),h=a==="audio"?Be:ye,u=new h(c,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:u,source:t}),yield(i=this.transport)==null?void 0:i.publish([u]),u.peerId=(s=this.localPeer)==null?void 0:s.peerId,(r=this.localPeer)==null||r.auxiliaryTracks.push(u),(n=this.listener)==null||n.onTrackUpdate(D.TRACK_ADDED,u,this.localPeer)})}removeTrack(e){return l(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex(s=>s.trackId===e);if(i>-1){let s=this.localPeer.auxiliaryTracks[i];yield this.transport.unpublish([s]),s.source==="audioplaylist"?this.playlistManager.stop(y.audio):s.source==="videoplaylist"&&this.playlistManager.stop(y.video),this.localPeer.auxiliaryTracks.splice(i,1),(t=this.listener)==null||t.onTrackUpdate(D.TRACK_REMOVED,s,this.localPeer)}else o.w(this.TAG,`No track found for ${e}`)})}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){o.level=e}addAudioListener(e){this.audioListener=e,this.notificationManager.setAudioListener(e)}addConnectionQualityListener(e){this.notificationManager.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return l(this,null,function*(){var s;!e.role||e.role.name===t||(yield(s=this.transport)==null?void 0:s.changeRole(e,t,i))})}acceptChangeRole(e){return l(this,null,function*(){var t;yield(t=this.transport)==null?void 0:t.acceptRoleChange(e)})}endRoom(e,t){return l(this,null,function*(){var i;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot end room");yield(i=this.transport)==null?void 0:i.endRoom(e,t),yield this.leave()})}removePeer(e,t){return l(this,null,function*(){var i;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot remove peer");if(!this.store.getPeerById(e.peerId))throw p.GenericErrors.ValidationFailed("Invalid peer, given peer not present in room",e);yield(i=this.transport)==null?void 0:i.removePeer(e.peerId,t)})}startRTMPOrRecording(e){return l(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot start streaming or recording");try{yield(t=this.transport)==null?void 0:t.startRTMPOrRecording(e)}catch(i){throw this.sendAnalyticsEvent(C.RTMPError(i)),i}})}stopRTMPAndRecording(){return l(this,null,function*(){var e;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot stop streaming or recording");try{yield(e=this.transport)==null?void 0:e.stopRTMPOrRecording()}catch(t){throw this.sendAnalyticsEvent(C.RTMPError(t,!1)),t}})}startHLSStreaming(e){return l(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot start HLS streaming");try{yield(t=this.transport)==null?void 0:t.startHLSStreaming(e)}catch(i){throw this.sendAnalyticsEvent(C.HLSError(i)),i}})}stopHLSStreaming(e){return l(this,null,function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected(g.VALIDATION,"No local peer present, cannot stop HLS streaming");try{yield(t=this.transport)==null?void 0:t.stopHLSStreaming(e)}catch(i){throw this.sendAnalyticsEvent(C.HLSError(i,!1)),i}})}sendHLSTimedMetadata(e){return l(this,null,function*(){var t;this.validateJoined("sendHLSTimedMetadata"),yield(t=this.transport)==null?void 0:t.sendHLSTimedMetadata(e)})}changeName(e){return l(this,null,function*(){var t;this.validateJoined("changeName"),yield(t=this.transport)==null?void 0:t.changeName(e),this.notificationManager.updateLocalPeer({name:e})})}changeMetadata(e){return l(this,null,function*(){var t;this.validateJoined("changeMetadata"),yield(t=this.transport)==null?void 0:t.changeMetadata(e),this.notificationManager.updateLocalPeer({metadata:e})})}setSessionMetadata(e){return l(this,null,function*(){yield this.transport.setSessionMetadata(e)})}getSessionMetadata(){return l(this,null,function*(){return(yield this.transport.getSessionMetadata()).data})}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return l(this,null,function*(){var i;if(e.type===w.VIDEO&&e.source!=="regular"){o.w(this.TAG,"Muting non-regular video tracks is currently not supported");return}if(e.enabled===t){o.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);return}if(!this.store.getTrackById(e.trackId))throw p.GenericErrors.ValidationFailed("No track found for change track state",e);let s=this.store.getPeerByTrackId(e.trackId);if(!s)throw p.GenericErrors.ValidationFailed("No peer found for change track state",e);yield(i=this.transport)==null?void 0:i.changeTrackState({requested_for:s.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})})}changeMultiTrackState(e){return l(this,null,function*(){var t;if(typeof e.enabled!="boolean")throw p.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:i,roles:s,type:r,source:n}=e;yield(t=this.transport)==null?void 0:t.changeMultiTrackState({value:!i,type:r,source:n,roles:s?.map(a=>a?.name)})})}setFrameworkInfo(e){this.frameworkInfo=e}publish(e){return l(this,null,function*(){let t=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(t),this.sdkState.published=!0})}setAndPublishTracks(e){return l(this,null,function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),(t=this.listener)==null||t.onTrackUpdate(D.TRACK_ADDED,i,this.localPeer);yield this.initDeviceManagers()})}setLocalPeerTrack(e){var t;switch(e.peerId=(t=this.localPeer)==null?void 0:t.peerId,e.type){case w.AUDIO:this.localPeer.audioTrack=e;break;case w.VIDEO:this.localPeer.videoTrack=e;break}}initDeviceManagers(){return l(this,null,function*(){var e,t,i,s,r;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice((t=(e=this.store.getConfig())==null?void 0:e.settings)==null?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice((s=(i=Y.getSelection())==null?void 0:i.audioOutput)==null?void 0:s.deviceId)),this.audioSinkManager.init((r=this.store.getConfig())==null?void 0:r.audioSinkElementId))})}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanUp(),this.audioSinkManager.cleanUp()}initPreviewTrackAudioLevelMonitor(){var e;let t=(e=this.localPeer)==null?void 0:e.audioTrack;t?.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe(i=>{var s;let r=i&&i.track.trackId===t?.trackId?[{audioLevel:i.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(r),(s=this.audioListener)==null||s.onAudioLevelUpdate(r)}),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var e;let t=this.store.getLocalPeer(),i=this.store.getRoom();if(i.joinedAt=new Date,t&&(t.joinedAt=i.joinedAt),t?.role){this.analyticsTimer.end(P.JOIN),(e=this.listener)==null||e.onJoin(i);return}return new Promise(s=>{this.eventBus.policyChange.subscribeOnce(()=>{var r;this.analyticsTimer.end(P.JOIN),(r=this.listener)==null||r.onJoin(i),s()})})}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:s,role:r}=yt(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,r,s),o.d(this.TAG,"SDK Store",this.store)}setPlaylistSettings(e){return l(this,arguments,function*({track:t,hmsTrack:i,source:s}){if(s==="videoplaylist"){let r={};if(t.kind==="audio")r.maxBitrate=64;else{r.maxBitrate=1e3;let{width:n,height:a}=t.getSettings();r.width=n,r.height=a}yield i.setSettings(r)}else s==="audioplaylist"&&(yield i.setSettings({maxBitrate:64}))})}createAndAddLocalPeerToStore(e,t,i){let s=this.store.getPolicyForRole(t),r=new Ti({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:s});this.store.addPeer(r)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new vs(t,this.store))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return l(this,null,function*(){let{video:i,audio:s}=this.getScreenshareSettings(t.videoOnly),[r,n]=yield this.transport.getLocalScreen(i,s),a=()=>{this.stopEndedScreenshare(e)},d=[];if(t.audioOnly){if(r.nativeTrack.stop(),!n)throw Error("Select share audio when sharing screen");d.push(n),n.nativeTrack.onended=a}else d.push(r),r.nativeTrack.onended=a,n&&d.push(n);return d})}};function $s(){return l(this,null,function*(){let e=new q().build(),t=new se().build();try{(yield ot(t)).stop()}catch(i){if(Cs(i))throw(yield Hi({audio:!1,video:!0})).getTracks().forEach(s=>s.stop()),i}return(yield lt(e)).stop(),!1})}function Cs(e){return e instanceof m&&e.action===g.TRACK}o.i("adapter",`${$e.Z.browserDetails.browser} v${$e.Z.browserDetails.version}`)}}]);

//# sourceMappingURL=28.5609cdfe.js.map